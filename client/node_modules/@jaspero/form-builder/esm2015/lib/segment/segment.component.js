import { moveItemInArray } from '@angular/cdk/drag-drop';
import { Component, HostBinding, Inject, Injector } from '@angular/core';
import { get } from 'json-pointer';
import { SEGMENT_DATA } from '../utils/create-segment-injector';
import { filterAndCompileSegments } from '../utils/filter-and-compile-segments';
export class SegmentComponent {
    constructor(sData, injector) {
        this.sData = sData;
        this.injector = injector;
        this.nestedArraySegments = [];
        this.arrayFields = [];
    }
    ngOnInit() {
        this.segment = this.sData.segment;
        this.classes = this.sData.segment.classes.join(' ');
        this.pointers = this.sData.parser.pointers;
        this.id = this.sData.segment.id || '';
        /**
         * Each segment compiles all nested segments
         */
        this.nestedSegments = filterAndCompileSegments(this.sData.segment.nestedSegments || [], this.sData.parser, this.sData.definitions, this.injector, this.segment.entryValue);
        const array = this.segment.array;
        /**
         * Add array items if necessary
         */
        if (array && this.segment.entryValue) {
            let values;
            try {
                values = get(this.segment.entryValue, array);
            }
            catch (e) { }
            if (values) {
                values.forEach(() => this.addArrayItem(false));
                this.pointers[array].control.patchValue(values);
                for (let i = 0; i < values.length; i++) {
                    // @ts-ignore
                    this.sData.parser.loadHooks(this.pointers[array].arrayPointers[i]);
                }
            }
        }
    }
    addArrayItem(loadHook = true) {
        const array = this.segment.array;
        const pointers = this.sData.parser.addArrayItem((this.sData.parent || '') + array, loadHook, this.sData.parent ? {
            pointer: this.sData.parent,
            index: 0
        } : undefined);
        let fields;
        if (this.segment.fields && this.segment.fields.length) {
            fields = this.segment.fields.map(key => {
                key = (this.sData.parent || '') + key;
                return this.sData.parser.field(key, pointers[key], this.sData.definitions, true, array);
            });
        }
        else {
            fields = [this.sData.parser.field(array, Object.assign(Object.assign({}, this.pointers[array]), { control: pointers }), this.sData.definitions)];
        }
        this.arrayFields.unshift(fields);
        this.nestedArraySegments.unshift(this.nestedSegments = filterAndCompileSegments(this.sData.segment.nestedSegments || [], this.sData.parser, this.sData.definitions, this.injector, this.segment.entryValue, this.segment.array));
    }
    moveArray(up, fromIndex) {
        let toIndex;
        if (up) {
            toIndex = fromIndex === 0 ? this.arrayFields.length - 1 : fromIndex - 1;
        }
        else {
            toIndex = fromIndex === (this.arrayFields.length - 1) ? 0 : fromIndex + 1;
        }
        moveItemInArray(this.arrayFields, fromIndex, toIndex);
        moveItemInArray(this.nestedArraySegments, fromIndex, toIndex);
        this.sData.parser.moveArrayItem((this.sData.parent || '') + this.segment.array, fromIndex, toIndex, this.sData.parent ? {
            pointer: this.sData.parent,
            index: 0
        } : undefined);
    }
    removeArrayItem(index) {
        this.sData.parser.removeArrayItem((this.sData.parent || '') + this.segment.array, index, this.sData.parent ? {
            pointer: this.sData.parent,
            index: 0
        } : undefined);
        this.nestedArraySegments.splice(index, 1);
        this.arrayFields.splice(index, 1);
    }
}
SegmentComponent.decorators = [
    { type: Component, args: [{
                selector: 'fb-segment',
                template: ''
            },] }
];
SegmentComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [SEGMENT_DATA,] }] },
    { type: Injector }
];
SegmentComponent.propDecorators = {
    classes: [{ type: HostBinding, args: ['class',] }],
    id: [{ type: HostBinding, args: ['id',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VnbWVudC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9mb3JtLWJ1aWxkZXIvc3JjL2xpYi9zZWdtZW50L3NlZ21lbnQuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUN2RCxPQUFPLEVBQUMsU0FBUyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsUUFBUSxFQUFTLE1BQU0sZUFBZSxDQUFDO0FBRS9FLE9BQU8sRUFBQyxHQUFHLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFJakMsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLGtDQUFrQyxDQUFDO0FBQzlELE9BQU8sRUFBQyx3QkFBd0IsRUFBQyxNQUFNLHNDQUFzQyxDQUFDO0FBYzlFLE1BQU0sT0FBTyxnQkFBZ0I7SUFDM0IsWUFDK0IsS0FBa0IsRUFDeEMsUUFBa0I7UUFESSxVQUFLLEdBQUwsS0FBSyxDQUFhO1FBQ3hDLGFBQVEsR0FBUixRQUFRLENBQVU7UUFNM0Isd0JBQW1CLEdBQTZCLEVBQUUsQ0FBQztRQUNuRCxnQkFBVyxHQUEyQixFQUFFLENBQUM7SUFOdEMsQ0FBQztJQWNKLFFBQVE7UUFDTixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQztRQUMzQyxJQUFJLENBQUMsRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFFdEM7O1dBRUc7UUFD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QUksQ0FBQyxPQUFPLENBQUMsS0FBZSxFQUN4RCxTQUFTLEVBQ1QsT0FBTyxFQUNQLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNsQixPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNO1lBQzFCLEtBQUssRUFBRSxDQUFDO1NBQ1QsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUNkLENBQUM7SUFDSixDQUFDO0lBRUQsZUFBZSxDQUFDLEtBQWE7UUFDM0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUMvQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxJQUFJLEVBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBZSxFQUN4RCxLQUFLLEVBQ0wsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLE9BQU8sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU07WUFDMUIsS0FBSyxFQUFFLENBQUM7U0FDVCxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQ2QsQ0FBQztRQUNGLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNwQyxDQUFDOzs7WUFsS0YsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxZQUFZO2dCQUN0QixRQUFRLEVBQUUsRUFBRTthQUNiOzs7NENBR0ksTUFBTSxTQUFDLFlBQVk7WUF2QmdCLFFBQVE7OztzQkFpQzdDLFdBQVcsU0FBQyxPQUFPO2lCQUduQixXQUFXLFNBQUMsSUFBSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7bW92ZUl0ZW1JbkFycmF5fSBmcm9tICdAYW5ndWxhci9jZGsvZHJhZy1kcm9wJztcbmltcG9ydCB7Q29tcG9uZW50LCBIb3N0QmluZGluZywgSW5qZWN0LCBJbmplY3RvciwgT25Jbml0fSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7Rm9ybUNvbnRyb2x9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7Z2V0fSBmcm9tICdqc29uLXBvaW50ZXInO1xuaW1wb3J0IHtDb21waWxlZEZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2VzL2NvbXBpbGVkLWZpZWxkLmludGVyZmFjZSc7XG5pbXBvcnQge0NvbXBpbGVkU2VnbWVudH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9jb21waWxlZC1zZWdtZW50LmludGVyZmFjZSc7XG5pbXBvcnQge0RlZmluaXRpb25zfSBmcm9tICcuLi9pbnRlcmZhY2VzL2RlZmluaXRpb25zLmludGVyZmFjZSc7XG5pbXBvcnQge1NFR01FTlRfREFUQX0gZnJvbSAnLi4vdXRpbHMvY3JlYXRlLXNlZ21lbnQtaW5qZWN0b3InO1xuaW1wb3J0IHtmaWx0ZXJBbmRDb21waWxlU2VnbWVudHN9IGZyb20gJy4uL3V0aWxzL2ZpbHRlci1hbmQtY29tcGlsZS1zZWdtZW50cyc7XG5pbXBvcnQge1BhcnNlciwgUG9pbnRlcnN9IGZyb20gJy4uL3V0aWxzL3BhcnNlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2VnbWVudERhdGEge1xuICBzZWdtZW50OiBDb21waWxlZFNlZ21lbnQ7XG4gIHBhcnNlcjogUGFyc2VyO1xuICBkZWZpbml0aW9uczogRGVmaW5pdGlvbnM7XG4gIHBhcmVudD86IHN0cmluZztcbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnZmItc2VnbWVudCcsXG4gIHRlbXBsYXRlOiAnJ1xufSlcbmV4cG9ydCBjbGFzcyBTZWdtZW50Q29tcG9uZW50PFQgPSBhbnk+IGltcGxlbWVudHMgT25Jbml0IHtcbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChTRUdNRU5UX0RBVEEpIHB1YmxpYyBzRGF0YTogU2VnbWVudERhdGEsXG4gICAgcHVibGljIGluamVjdG9yOiBJbmplY3RvclxuICApIHt9XG5cbiAgc2VnbWVudDogQ29tcGlsZWRTZWdtZW50PFQ+O1xuICBwb2ludGVyczogUG9pbnRlcnM7XG4gIG5lc3RlZFNlZ21lbnRzOiBDb21waWxlZFNlZ21lbnQ8VD5bXTtcbiAgbmVzdGVkQXJyYXlTZWdtZW50czogQXJyYXk8Q29tcGlsZWRTZWdtZW50W10+ID0gW107XG4gIGFycmF5RmllbGRzOiBBcnJheTxDb21waWxlZEZpZWxkW10+ID0gW107XG5cbiAgQEhvc3RCaW5kaW5nKCdjbGFzcycpXG4gIGNsYXNzZXM6IHN0cmluZztcblxuICBASG9zdEJpbmRpbmcoJ2lkJylcbiAgaWQ6IHN0cmluZztcblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnNlZ21lbnQgPSB0aGlzLnNEYXRhLnNlZ21lbnQ7XG4gICAgdGhpcy5jbGFzc2VzID0gdGhpcy5zRGF0YS5zZWdtZW50LmNsYXNzZXMuam9pbignICcpO1xuICAgIHRoaXMucG9pbnRlcnMgPSB0aGlzLnNEYXRhLnBhcnNlci5wb2ludGVycztcbiAgICB0aGlzLmlkID0gdGhpcy5zRGF0YS5zZWdtZW50LmlkIHx8ICcnO1xuXG4gICAgLyoqXG4gICAgICogRWFjaCBzZWdtZW50IGNvbXBpbGVzIGFsbCBuZXN0ZWQgc2VnbWVudHNcbiAgICAgKi9cbiAgICB0aGlzLm5lc3RlZFNlZ21lbnRzID0gZmlsdGVyQW5kQ29tcGlsZVNlZ21lbnRzKFxuICAgICAgdGhpcy5zRGF0YS5zZWdtZW50Lm5lc3RlZFNlZ21lbnRzIHx8IFtdLFxuICAgICAgdGhpcy5zRGF0YS5wYXJzZXIsXG4gICAgICB0aGlzLnNEYXRhLmRlZmluaXRpb25zLFxuICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgIHRoaXMuc2VnbWVudC5lbnRyeVZhbHVlXG4gICAgKTtcblxuICAgIGNvbnN0IGFycmF5ID0gdGhpcy5zZWdtZW50LmFycmF5IGFzIHN0cmluZztcblxuICAgIC8qKlxuICAgICAqIEFkZCBhcnJheSBpdGVtcyBpZiBuZWNlc3NhcnlcbiAgICAgKi9cbiAgICBpZiAoYXJyYXkgJiYgdGhpcy5zZWdtZW50LmVudHJ5VmFsdWUpIHtcbiAgICAgIGxldCB2YWx1ZXM7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIHZhbHVlcyA9IGdldCh0aGlzLnNlZ21lbnQuZW50cnlWYWx1ZSwgYXJyYXkpO1xuICAgICAgfSBjYXRjaCAoZSkge31cblxuICAgICAgaWYgKHZhbHVlcykge1xuICAgICAgICB2YWx1ZXMuZm9yRWFjaCgoKSA9PiB0aGlzLmFkZEFycmF5SXRlbShmYWxzZSkpO1xuXG4gICAgICAgICh0aGlzLnBvaW50ZXJzW2FycmF5XS5jb250cm9sIGFzIEZvcm1Db250cm9sKS5wYXRjaFZhbHVlKFxuICAgICAgICAgIHZhbHVlc1xuICAgICAgICApO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmFsdWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgIHRoaXMuc0RhdGEucGFyc2VyLmxvYWRIb29rcyh0aGlzLnBvaW50ZXJzW2FycmF5XS5hcnJheVBvaW50ZXJzW2ldKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFkZEFycmF5SXRlbShsb2FkSG9vayA9IHRydWUpIHtcbiAgICBjb25zdCBhcnJheSA9IHRoaXMuc2VnbWVudC5hcnJheSBhcyBzdHJpbmc7XG4gICAgY29uc3QgcG9pbnRlcnM6IGFueSA9IHRoaXMuc0RhdGEucGFyc2VyLmFkZEFycmF5SXRlbShcbiAgICAgICh0aGlzLnNEYXRhLnBhcmVudCB8fCAnJykgKyBhcnJheSxcbiAgICAgIGxvYWRIb29rLFxuICAgICAgdGhpcy5zRGF0YS5wYXJlbnQgPyB7XG4gICAgICAgIHBvaW50ZXI6IHRoaXMuc0RhdGEucGFyZW50LFxuICAgICAgICBpbmRleDogMFxuICAgICAgfSA6IHVuZGVmaW5lZFxuICAgICk7XG5cbiAgICBsZXQgZmllbGRzOiBDb21waWxlZEZpZWxkW107XG5cbiAgICBpZiAodGhpcy5zZWdtZW50LmZpZWxkcyAmJiB0aGlzLnNlZ21lbnQuZmllbGRzLmxlbmd0aCkge1xuICAgICAgZmllbGRzID0gKHRoaXMuc2VnbWVudC5maWVsZHMgYXMgc3RyaW5nW10pLm1hcChrZXkgPT4ge1xuXG4gICAgICAgIGtleSA9ICh0aGlzLnNEYXRhLnBhcmVudCB8fCAnJykgKyBrZXk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuc0RhdGEucGFyc2VyLmZpZWxkKFxuICAgICAgICAgIGtleSxcbiAgICAgICAgICBwb2ludGVyc1trZXldLFxuICAgICAgICAgIHRoaXMuc0RhdGEuZGVmaW5pdGlvbnMsXG4gICAgICAgICAgdHJ1ZSxcbiAgICAgICAgICBhcnJheVxuICAgICAgICApO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZpZWxkcyA9IFt0aGlzLnNEYXRhLnBhcnNlci5maWVsZChcbiAgICAgICAgYXJyYXksXG4gICAgICAgIHtcbiAgICAgICAgICAuLi50aGlzLnBvaW50ZXJzW2FycmF5XSxcbiAgICAgICAgICBjb250cm9sOiBwb2ludGVyc1xuICAgICAgICB9LFxuICAgICAgICB0aGlzLnNEYXRhLmRlZmluaXRpb25zXG4gICAgICApXTtcbiAgICB9XG5cbiAgICB0aGlzLmFycmF5RmllbGRzLnVuc2hpZnQoXG4gICAgICBmaWVsZHNcbiAgICApO1xuXG4gICAgdGhpcy5uZXN0ZWRBcnJheVNlZ21lbnRzLnVuc2hpZnQoXG4gICAgICB0aGlzLm5lc3RlZFNlZ21lbnRzID0gZmlsdGVyQW5kQ29tcGlsZVNlZ21lbnRzKFxuICAgICAgICB0aGlzLnNEYXRhLnNlZ21lbnQubmVzdGVkU2VnbWVudHMgfHwgW10sXG4gICAgICAgIHRoaXMuc0RhdGEucGFyc2VyLFxuICAgICAgICB0aGlzLnNEYXRhLmRlZmluaXRpb25zLFxuICAgICAgICB0aGlzLmluamVjdG9yLFxuICAgICAgICB0aGlzLnNlZ21lbnQuZW50cnlWYWx1ZSxcbiAgICAgICAgdGhpcy5zZWdtZW50LmFycmF5XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIG1vdmVBcnJheSh1cDogYm9vbGVhbiwgZnJvbUluZGV4OiBudW1iZXIpIHtcbiAgICBsZXQgdG9JbmRleDogbnVtYmVyO1xuXG4gICAgaWYgKHVwKSB7XG4gICAgICB0b0luZGV4ID0gZnJvbUluZGV4ID09PSAwID8gdGhpcy5hcnJheUZpZWxkcy5sZW5ndGggLSAxIDogZnJvbUluZGV4IC0gMTtcbiAgICB9IGVsc2Uge1xuICAgICAgdG9JbmRleCA9IGZyb21JbmRleCA9PT0gKHRoaXMuYXJyYXlGaWVsZHMubGVuZ3RoIC0gMSkgPyAwIDogZnJvbUluZGV4ICsgMTtcbiAgICB9XG5cbiAgICBtb3ZlSXRlbUluQXJyYXkoXG4gICAgICB0aGlzLmFycmF5RmllbGRzLFxuICAgICAgZnJvbUluZGV4LFxuICAgICAgdG9JbmRleFxuICAgICk7XG5cbiAgICBtb3ZlSXRlbUluQXJyYXkoXG4gICAgICB0aGlzLm5lc3RlZEFycmF5U2VnbWVudHMsXG4gICAgICBmcm9tSW5kZXgsXG4gICAgICB0b0luZGV4XG4gICAgKTtcblxuICAgIHRoaXMuc0RhdGEucGFyc2VyLm1vdmVBcnJheUl0ZW0oXG4gICAgICAodGhpcy5zRGF0YS5wYXJlbnQgfHwgJycpICsgdGhpcy5zZWdtZW50LmFycmF5IGFzIHN0cmluZyxcbiAgICAgIGZyb21JbmRleCxcbiAgICAgIHRvSW5kZXgsXG4gICAgICB0aGlzLnNEYXRhLnBhcmVudCA/IHtcbiAgICAgICAgcG9pbnRlcjogdGhpcy5zRGF0YS5wYXJlbnQsXG4gICAgICAgIGluZGV4OiAwXG4gICAgICB9IDogdW5kZWZpbmVkXG4gICAgKTtcbiAgfVxuXG4gIHJlbW92ZUFycmF5SXRlbShpbmRleDogbnVtYmVyKSB7XG4gICAgdGhpcy5zRGF0YS5wYXJzZXIucmVtb3ZlQXJyYXlJdGVtKFxuICAgICAgKHRoaXMuc0RhdGEucGFyZW50IHx8ICcnKSArIHRoaXMuc2VnbWVudC5hcnJheSBhcyBzdHJpbmcsXG4gICAgICBpbmRleCxcbiAgICAgIHRoaXMuc0RhdGEucGFyZW50ID8ge1xuICAgICAgICBwb2ludGVyOiB0aGlzLnNEYXRhLnBhcmVudCxcbiAgICAgICAgaW5kZXg6IDBcbiAgICAgIH0gOiB1bmRlZmluZWRcbiAgICApO1xuICAgIHRoaXMubmVzdGVkQXJyYXlTZWdtZW50cy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIHRoaXMuYXJyYXlGaWVsZHMuc3BsaWNlKGluZGV4LCAxKTtcbiAgfVxufVxuIl19