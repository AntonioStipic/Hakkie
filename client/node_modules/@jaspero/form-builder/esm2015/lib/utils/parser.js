import { moveItemInArray } from '@angular/cdk/drag-drop';
import { ComponentPortal } from '@angular/cdk/portal';
import { FormArray, FormControl, FormGroup, Validators } from '@angular/forms';
import { COMPONENT_TYPE_COMPONENT_MAP } from '../consts/component-type-component-map.const';
import { SchemaType } from '../enums/schema-type.enum';
import { State } from '../enums/state.enum';
import { SchemaValidators } from '../validators/schema-validators.class';
import { createComponentInjector } from './create-component-injector';
import { safeEval } from './safe-eval';
import { schemaToComponent } from './schema-to-component';
// @dynamic
export class Parser {
    constructor(schema, injector, state, role, definitions = {}, customFields = {}) {
        this.schema = schema;
        this.injector = injector;
        this.state = state;
        this.role = role;
        this.definitions = definitions;
        this.customFields = customFields;
        this.pointers = {};
    }
    static standardizeKey(key) {
        if (key[0] === '/') {
            key = key.slice(1, key.length);
        }
        return key;
    }
    static stringControl(definition, required) {
        const controlValidation = [];
        const validation = {};
        if (required) {
            controlValidation.push(Validators.required);
            validation.required = true;
        }
        if (definition.maxLength) {
            controlValidation.push(Validators.maxLength(definition.maxLength));
            validation.maxLength = definition.maxLength;
        }
        if (definition.minLength) {
            controlValidation.push(Validators.minLength(definition.minLength));
            validation.minLength = definition.minLength;
        }
        if (definition.pattern) {
            controlValidation.push(Validators.pattern(definition.pattern));
            validation.patter = definition.pattern;
        }
        return {
            control: new FormControl(definition.default || '', controlValidation),
            validation
        };
    }
    static numberControl(definition, required) {
        const validation = {};
        const controlValidation = [];
        if (required) {
            controlValidation.push(Validators.required);
            validation.required = true;
        }
        if (definition.minimum) {
            const minimum = definition.minimum + (definition.exclusiveMinimum ? 1 : 0);
            controlValidation.push(Validators.min(minimum));
            validation.minimum = minimum;
        }
        if (definition.maximum) {
            const maximum = definition.maximum - (definition.exclusiveMaximum ? 1 : 0);
            controlValidation.push(Validators.max(maximum));
            validation.maximum = maximum;
        }
        if (definition.multipleOf) {
            controlValidation.push(SchemaValidators.multipleOf(definition.multipleOf));
            validation.multipleOf = definition.multipleOf;
        }
        return {
            control: new FormControl(definition.default || null, controlValidation),
            validation
        };
    }
    static booleanControl(definition, required) {
        const controlValidation = [];
        const validation = {};
        if (required) {
            controlValidation.push(Validators.required);
            validation.required = true;
        }
        return {
            control: new FormControl(definition.default || false, controlValidation),
            validation
        };
    }
    buildForm(value, required = [], base = '/', addId = true) {
        const properties = this.buildProperties(this.schema.properties || {}, required, base, addId);
        this.form = properties.form;
        this.pointers = properties.pointers;
        if (value) {
            this.form.patchValue(value);
        }
        return this.form;
    }
    buildProperties(properties, required = [], base = '/', addId = true) {
        const { form, pointers } = [
            ...Object.entries(properties),
            /**
             * Add the id field as a property so that
             * it can be added to the form if needed
             */
            ...(addId
                ? [
                    [
                        'id',
                        {
                            type: 'string'
                        }
                    ]
                ]
                : [])
        ].reduce((group, [key, value]) => {
            const isRequired = required.includes(key);
            let parsed;
            switch (value.type) {
                case SchemaType.String:
                    parsed = Parser.stringControl(value, isRequired);
                    break;
                case SchemaType.Number:
                case SchemaType.Integer:
                    parsed = Parser.numberControl(value, isRequired);
                    break;
                case SchemaType.Boolean:
                    parsed = Parser.booleanControl(value, isRequired);
                    break;
                case SchemaType.Object:
                    const objectProperties = this.buildProperties(
                    /**
                     * Supporting both {type: 'object', properties: {}} and
                     * {type: 'object', items: {properties: {}}}
                     */
                    value.properties || (value.items && value.items.properties ? value.items.properties : {}), value.required || value.items && value.items.required ? value.items.required : [], base + key + '/', false);
                    for (const added in objectProperties.pointers) {
                        if (objectProperties.pointers.hasOwnProperty(added)) {
                            // @ts-ignore
                            group.pointers[added] = objectProperties.pointers[added];
                        }
                    }
                    parsed = {
                        control: objectProperties.form,
                        validation: {}
                    };
                    break;
                case SchemaType.Array:
                    parsed = this.buildArray(base, value);
                    break;
            }
            const pointerKey = base + key;
            const definition = this.getFromDefinitions(pointerKey) || {};
            // @ts-ignore
            group.form[key] = parsed.control;
            // @ts-ignore
            group.pointers[pointerKey] = Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({ key, type: value.type }, definition.formatOnLoad
                && { formatOnLoad: safeEval(definition.formatOnLoad) }), definition.formatOnSave
                && { formatOnSave: safeEval(definition.formatOnSave) }), definition.formatOnCreate
                && { formatOnCreate: safeEval(definition.formatOnCreate) }), definition.formatOnEdit
                && { formatOnEdit: safeEval(definition.formatOnEdit) }), parsed);
            return group;
        }, {
            form: {},
            pointers: {}
        });
        return {
            pointers,
            form: new FormGroup(form)
        };
    }
    /**
     * @param pointerKey Lookup key for the pointer
     * @param pointer Entire pointer object that should be used
     * @param definitions Entire definitions object that should be used
     * @param single Defines if the field shown in the form or in the table
     * @param arrayRoot If the field is in an array what root lookup to use
     */
    field(pointerKey, pointer, definitions = {}, single = true, arrayRoot) {
        if (!pointer) {
            console.log('Pointers: ', this.pointers);
            throw new Error(`Couldn't find pointer for ${pointerKey}.`);
        }
        const { key, type, control, validation } = pointer;
        const definition = Object.assign({ label: key }, this.getFromDefinitions(pointerKey, definitions));
        if ((definition.disableOn &&
            (Array.isArray(definition.disableOn) ?
                definition.disableOn.includes(this.state)
                : definition.disableOn === this.state)) ||
            (definition.disableForRoles &&
                (Array.isArray(definition.disableForRoles) ?
                    definition.disableForRoles.includes(this.role)
                    : definition.disableForRoles === this.role))) {
            control.disable();
        }
        /**
         * We don't show labels in the table
         */
        if (!single) {
            definition.label = '';
        }
        if (!definition.component) {
            definition.component = schemaToComponent(type);
        }
        // @ts-ignore
        const component = COMPONENT_TYPE_COMPONENT_MAP[definition.component.type] || this.customFields[definition.component.type];
        if (!component) {
            // @ts-ignore
            throw new Error(`Couldn't find a component defined for type: ${definition.component.type}`);
        }
        const portal = new ComponentPortal(component, null, createComponentInjector(this.injector, Object.assign(Object.assign({ control,
            validation,
            single, pointers: this.pointers, form: this.form }, definition), (definition.component.configuration || {}))));
        return {
            pointer: pointerKey,
            control,
            portal,
            validation,
            placeholder: definition.placeholder || '',
            label: definition.label,
            onlyOn: definition.onlyOn
        };
    }
    addArrayItem(pointer, loadHooks = false, parentArray) {
        const pointers = parentArray ? this.pointers[parentArray.pointer].arrayPointers[parentArray.index] : this.pointers;
        const target = pointers[pointer];
        const control = pointers[pointer].control;
        if (target.arrayType === SchemaType.Array ||
            target.arrayType === SchemaType.Object) {
            const properties = this.buildProperties(target.properties, target.required, pointer + '/', false);
            if (loadHooks) {
                this.loadHooks(properties.pointers);
            }
            // @ts-ignore
            target.arrayPointers.unshift(properties.pointers);
            control.controls.unshift(properties.form);
            return properties.pointers;
        }
        else {
            const cont = new FormControl('');
            control.controls.unshift(cont);
            return cont;
        }
    }
    moveArrayItem(pointer, fromIndex, toIndex, parentArray) {
        const pointers = parentArray ? this.pointers[parentArray.pointer].arrayPointers[parentArray.index] : this.pointers;
        const target = pointers[pointer];
        const control = pointers[pointer].control;
        if (target.arrayType === SchemaType.Array ||
            target.arrayType === SchemaType.Object) {
            moveItemInArray(target.arrayPointers, fromIndex, toIndex);
        }
        moveItemInArray(control.controls, fromIndex, toIndex);
    }
    removeArrayItem(pointer, index, parentArray) {
        const pointers = parentArray ? this.pointers[parentArray.pointer].arrayPointers[parentArray.index] : this.pointers;
        pointers[pointer].arrayPointers.splice(index, 1);
        pointers[pointer].control.removeAt(index);
    }
    loadHooks(pointers = this.pointers) {
        Object.values(pointers).forEach(entry => {
            /**
             * TODO:
             * For the moment formatOn methods are
             * only supported on FormControls.
             * We might want to expand on this later on.
             */
            if (entry.control instanceof FormControl && entry.formatOnLoad) {
                const adjustedValue = entry.formatOnLoad(entry.control.value);
                if (adjustedValue !== entry.control.value) {
                    entry.control.setValue(adjustedValue);
                }
            }
        });
    }
    preSaveHooks(currentState, statesToProcess = [State.Create, State.Edit], pointers = this.pointers) {
        const preSaveData = this.form.getRawValue();
        Object.values(pointers).forEach(entry => {
            /**
             * TODO:
             * For the moment formatOn methods are
             * only supported on FormControls.
             * We might want to expand on this later on.
             */
            if (entry.control instanceof FormControl) {
                let value = entry.control.value;
                if (entry.formatOnSave) {
                    value = entry.formatOnSave(value, preSaveData);
                }
                if (statesToProcess.includes(currentState)) {
                    if (currentState === State.Edit && entry.formatOnEdit) {
                        value = entry.formatOnEdit(value, preSaveData);
                    }
                    else if (entry.formatOnCreate) {
                        value = entry.formatOnCreate(value, preSaveData);
                    }
                }
                if (value !== entry.control.value) {
                    entry.control.setValue(value);
                }
            }
            if (entry.arrayPointers) {
                entry.arrayPointers.forEach(arrayPointers => this.preSaveHooks(currentState, statesToProcess, arrayPointers));
            }
        });
    }
    getFromDefinitions(key, definitions = this.definitions) {
        return definitions[Parser.standardizeKey(key)];
    }
    /**
     * TODO:
     * - Handle contains case
     * - Handle items or contains as array not object
     */
    buildArray(base, definition) {
        if (!definition.items) {
            return Object.assign({ control: new FormControl([]) }, (definition.items
                ? {
                    arrayType: definition.items.type,
                    properties: definition.items.properties,
                    required: definition.items.required,
                    validation: {}
                }
                : {
                    arrayType: SchemaType.String,
                    validation: {}
                }));
        }
        else {
            return {
                arrayType: definition.items.type,
                properties: definition.items.properties,
                required: definition.items.required,
                validation: {},
                control: new FormArray([]),
                arrayPointers: []
            };
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvZm9ybS1idWlsZGVyL3NyYy9saWIvdXRpbHMvcGFyc2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxlQUFlLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUN2RCxPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFFcEQsT0FBTyxFQUFDLFNBQVMsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzdFLE9BQU8sRUFBQyw0QkFBNEIsRUFBQyxNQUFNLDhDQUE4QyxDQUFDO0FBQzFGLE9BQU8sRUFBQyxVQUFVLEVBQUMsTUFBTSwyQkFBMkIsQ0FBQztBQUNyRCxPQUFPLEVBQUMsS0FBSyxFQUFDLE1BQU0scUJBQXFCLENBQUM7QUFLMUMsT0FBTyxFQUFDLGdCQUFnQixFQUFDLE1BQU0sdUNBQXVDLENBQUM7QUFDdkUsT0FBTyxFQUFDLHVCQUF1QixFQUFDLE1BQU0sNkJBQTZCLENBQUM7QUFFcEUsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGFBQWEsQ0FBQztBQUNyQyxPQUFPLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSx1QkFBdUIsQ0FBQztBQStEeEQsV0FBVztBQUNYLE1BQU0sT0FBTyxNQUFNO0lBQ2pCLFlBQ1MsTUFBVyxFQUNYLFFBQWtCLEVBQ2xCLEtBQVksRUFDWixJQUFZLEVBQ1osY0FBMkIsRUFBRSxFQUM3QixlQUE2QixFQUFFO1FBTC9CLFdBQU0sR0FBTixNQUFNLENBQUs7UUFDWCxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLFVBQUssR0FBTCxLQUFLLENBQU87UUFDWixTQUFJLEdBQUosSUFBSSxDQUFRO1FBQ1osZ0JBQVcsR0FBWCxXQUFXLENBQWtCO1FBQzdCLGlCQUFZLEdBQVosWUFBWSxDQUFtQjtRQUl4QyxhQUFRLEdBQWEs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U0FBUyxDQUFDLEVBQUUsQ0FBQztnQkFDMUIsYUFBYSxFQUFFLEVBQUU7YUFDbEIsQ0FBQztTQUNIO0lBQ0gsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHttb3ZlSXRlbUluQXJyYXl9IGZyb20gJ0Bhbmd1bGFyL2Nkay9kcmFnLWRyb3AnO1xuaW1wb3J0IHtDb21wb25lbnRQb3J0YWx9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wb3J0YWwnO1xuaW1wb3J0IHtJbmplY3Rvcn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0Zvcm1BcnJheSwgRm9ybUNvbnRyb2wsIEZvcm1Hcm91cCwgVmFsaWRhdG9yc30gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHtDT01QT05FTlRfVFlQRV9DT01QT05FTlRfTUFQfSBmcm9tICcuLi9jb25zdHMvY29tcG9uZW50LXR5cGUtY29tcG9uZW50LW1hcC5jb25zdCc7XG5pbXBvcnQge1NjaGVtYVR5cGV9IGZyb20gJy4uL2VudW1zL3NjaGVtYS10eXBlLmVudW0nO1xuaW1wb3J0IHtTdGF0ZX0gZnJvbSAnLi4vZW51bXMvc3RhdGUuZW51bSc7XG5pbXBvcnQge0ZpZWxkQ29tcG9uZW50fSBmcm9tICcuLi9maWVsZC9maWVsZC5jb21wb25lbnQnO1xuaW1wb3J0IHtDb21waWxlZEZpZWxkfSBmcm9tICcuLi9pbnRlcmZhY2VzL2NvbXBpbGVkLWZpZWxkLmludGVyZmFjZSc7XG5pbXBvcnQge0NvbnRyb2x9IGZyb20gJy4uL2ludGVyZmFjZXMvY29udHJvbC50eXBlJztcbmltcG9ydCB7RGVmaW5pdGlvbnN9IGZyb20gJy4uL2ludGVyZmFjZXMvZGVmaW5pdGlvbnMuaW50ZXJmYWNlJztcbmltcG9ydCB7U2NoZW1hVmFsaWRhdG9yc30gZnJvbSAnLi4vdmFsaWRhdG9ycy9zY2hlbWEtdmFsaWRhdG9ycy5jbGFzcyc7XG5pbXBvcnQge2NyZWF0ZUNvbXBvbmVudEluamVjdG9yfSBmcm9tICcuL2NyZWF0ZS1jb21wb25lbnQtaW5qZWN0b3InO1xuaW1wb3J0IHtDdXN0b21GaWVsZHN9IGZyb20gJy4vY3VzdG9tLWZpZWxkcyc7XG5pbXBvcnQge3NhZmVFdmFsfSBmcm9tICcuL3NhZmUtZXZhbCc7XG5pbXBvcnQge3NjaGVtYVRvQ29tcG9uZW50fSBmcm9tICcuL3NjaGVtYS10by1jb21wb25lbnQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFByb3BlcnR5RGVmaW5pdGlvbiB7XG4gIHR5cGU6IFNjaGVtYVR5cGU7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICBkZWZhdWx0PzogYW55O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN0cmluZ1Byb3BlcnR5RGVmaW5pdGlvbiBleHRlbmRzIFByb3BlcnR5RGVmaW5pdGlvbiB7XG4gIHR5cGU6IFNjaGVtYVR5cGUuU3RyaW5nO1xuICBkZWZhdWx0Pzogc3RyaW5nO1xuXG4gIHBhdHRlcm4/OiBzdHJpbmc7XG4gIG1pbkxlbmd0aD86IG51bWJlcjtcbiAgbWF4TGVuZ3RoPzogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE51bWJlclByb3BlcnR5RGVmaW5pdGlvbiBleHRlbmRzIFByb3BlcnR5RGVmaW5pdGlvbiB7XG4gIHR5cGU6IFNjaGVtYVR5cGUuTnVtYmVyIHwgU2NoZW1hVHlwZS5JbnRlZ2VyO1xuICBkZWZhdWx0PzogbnVtYmVyO1xuXG4gIG1pbmltdW0/OiBudW1iZXI7XG4gIG1heGltdW0/OiBudW1iZXI7XG4gIGV4Y2x1c2l2ZU1pbmltdW0/OiBib29sZWFuO1xuICBleGNsdXNpdmVNYXhpbXVtPzogYm9vbGVhbjtcbiAgbXVsdGlwbGVPZj86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCb29sZWFuUHJvcGVydHlEZWZpbml0aW9uIGV4dGVuZHMgUHJvcGVydHlEZWZpbml0aW9uIHtcbiAgdHlwZTogU2NoZW1hVHlwZS5Cb29sZWFuO1xuICBkZWZhdWx0PzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBcnJheVByb3BlcnR5RGVmaW5pdGlvbiBleHRlbmRzIFByb3BlcnR5RGVmaW5pdGlvbiB7XG4gIHR5cGU6IFNjaGVtYVR5cGUuQXJyYXk7XG4gIGl0ZW1zPzogYW55O1xuICBjb250YWlucz86IGFueTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQb2ludGVyIHtcbiAga2V5OiBzdHJpbmc7XG4gIHR5cGU6IFNjaGVtYVR5cGU7XG4gIGNvbnRyb2w6IENvbnRyb2w7XG4gIHZhbGlkYXRpb246IGFueTtcblxuICBmb3JtYXRPblNhdmU/OiAoaXRlbTogYW55LCBkYXRhU2V0PzogYW55KSA9PiBhbnk7XG4gIGZvcm1hdE9uTG9hZD86IChpdGVtOiBhbnkpID0+IGFueTtcbiAgZm9ybWF0T25DcmVhdGU/OiAoaXRlbTogYW55LCBkYXRhU2V0PzogYW55KSA9PiBhbnk7XG4gIGZvcm1hdE9uRWRpdD86IChpdGVtOiBhbnksIGRhdGFTZXQ/OiBhbnkpID0+IGFueTtcblxuICAvKipcbiAgICogQXJyYXlzIGNhbiBoYXZlIHRoZXNlIHByb3BlcnRpZXNcbiAgICovXG4gIGFycmF5VHlwZT86IFNjaGVtYVR5cGU7XG4gIHByb3BlcnRpZXM/OiBhbnk7XG4gIHJlcXVpcmVkPzogc3RyaW5nW107XG4gIGFycmF5UG9pbnRlcnM/OiBQb2ludGVyc1tdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBvaW50ZXJzIHtcbiAgW2tleTogc3RyaW5nXTogUG9pbnRlcjtcbn1cblxuLy8gQGR5bmFtaWNcbmV4cG9ydCBjbGFzcyBQYXJzZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgc2NoZW1hOiBhbnksXG4gICAgcHVibGljIGluamVjdG9yOiBJbmplY3RvcixcbiAgICBwdWJsaWMgc3RhdGU6IFN0YXRlLFxuICAgIHB1YmxpYyByb2xlOiBzdHJpbmcsXG4gICAgcHVibGljIGRlZmluaXRpb25zOiBEZWZpbml0aW9ucyA9IHt9LFxuICAgIHB1YmxpYyBjdXN0b21GaWVsZHM6IEN1c3RvbUZpZWxkcyA9IHt9XG4gICkge31cblxuICBmb3JtOiBGb3JtR3JvdXA7XG4gIHBvaW50ZXJzOiBQb2ludGVycyA9IHt9O1xuXG4gIHN0YXRpYyBzdGFuZGFyZGl6ZUtleShrZXk6IHN0cmluZykge1xuICAgIGlmIChrZXlbMF0gPT09ICcvJykge1xuICAgICAga2V5ID0ga2V5LnNsaWNlKDEsIGtleS5sZW5ndGgpO1xuICAgIH1cblxuICAgIHJldHVybiBrZXk7XG4gIH1cblxuICBzdGF0aWMgc3RyaW5nQ29udHJvbChcbiAgICBkZWZpbml0aW9uOiBTdHJpbmdQcm9wZXJ0eURlZmluaXRpb24sXG4gICAgcmVxdWlyZWQ6IGJvb2xlYW5cbiAgKSB7XG4gICAgY29uc3QgY29udHJvbFZhbGlkYXRpb246IGFueVtdID0gW107XG4gICAgY29uc3QgdmFsaWRhdGlvbjogYW55ID0ge307XG5cbiAgICBpZiAocmVxdWlyZWQpIHtcbiAgICAgIGNvbnRyb2xWYWxpZGF0aW9uLnB1c2goVmFsaWRhdG9ycy5yZXF1aXJlZCk7XG4gICAgICB2YWxpZGF0aW9uLnJlcXVpcmVkID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBpZiAoZGVmaW5pdGlvbi5tYXhMZW5ndGgpIHtcbiAgICAgIGNvbnRyb2xWYWxpZGF0aW9uLnB1c2goVmFsaWRhdG9ycy5tYXhMZW5ndGgoZGVmaW5pdGlvbi5tYXhMZW5ndGgpKTtcbiAgICAgIHZhbGlkYXRpb24ubWF4TGVuZ3RoID0gZGVmaW5pdGlvbi5tYXhMZW5ndGg7XG4gICAgfVxuXG4gICAgaWYgKGRlZmluaXRpb24ubWluTGVuZ3RoKSB7XG4gICAgICBjb250cm9sVmFsaWRhdGlvbi5wdXNoKFZhbGlkYXRvcnMubWluTGVuZ3RoKGRlZmluaXRpb24ubWluTGVuZ3RoKSk7XG4gICAgICB2YWxpZGF0aW9uLm1pbkxlbmd0aCA9IGRlZmluaXRpb24ubWluTGVuZ3RoO1xuICAgIH1cblxuICAgIGlmIChkZWZpbml0aW9uLnBhdHRlcm4pIHtcbiAgICAgIGNvbnRyb2xWYWxpZGF0aW9uLnB1c2goVmFsaWRhdG9ycy5wYXR0ZXJuKGRlZmluaXRpb24ucGF0dGVybikpO1xuICAgICAgdmFsaWRhdGlvbi5wYXR0ZXIgPSBkZWZpbml0aW9uLnBhdHRlcm47XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbnRyb2w6IG5ldyBGb3JtQ29udHJvbChkZWZpbml0aW9uLmRlZmF1bHQgfHwgJycsIGNvbnRyb2xWYWxpZGF0aW9uKSxcbiAgICAgIHZhbGlkYXRpb25cbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIG51bWJlckNvbnRyb2woXG4gICAgZGVmaW5pdGlvbjogTnVtYmVyUHJvcGVydHlEZWZpbml0aW9uLFxuICAgIHJlcXVpcmVkOiBib29sZWFuXG4gICkge1xuICAgIGNvbnN0IHZhbGlkYXRpb246IGFueSA9IHt9O1xuICAgIGNvbnN0IGNvbnRyb2xWYWxpZGF0aW9uOiBhbnlbXSA9IFtdO1xuXG4gICAgaWYgKHJlcXVpcmVkKSB7XG4gICAgICBjb250cm9sVmFsaWRhdGlvbi5wdXNoKFZhbGlkYXRvcnMucmVxdWlyZWQpO1xuICAgICAgdmFsaWRhdGlvbi5yZXF1aXJlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKGRlZmluaXRpb24ubWluaW11bSkge1xuICAgICAgY29uc3QgbWluaW11bSA9XG4gICAgICAgIGRlZmluaXRpb24ubWluaW11bSArIChkZWZpbml0aW9uLmV4Y2x1c2l2ZU1pbmltdW0gPyAxIDogMCk7XG4gICAgICBjb250cm9sVmFsaWRhdGlvbi5wdXNoKFZhbGlkYXRvcnMubWluKG1pbmltdW0pKTtcbiAgICAgIHZhbGlkYXRpb24ubWluaW11bSA9IG1pbmltdW07XG4gICAgfVxuXG4gICAgaWYgKGRlZmluaXRpb24ubWF4aW11bSkge1xuICAgICAgY29uc3QgbWF4aW11bSA9XG4gICAgICAgIGRlZmluaXRpb24ubWF4aW11bSAtIChkZWZpbml0aW9uLmV4Y2x1c2l2ZU1heGltdW0gPyAxIDogMCk7XG4gICAgICBjb250cm9sVmFsaWRhdGlvbi5wdXNoKFZhbGlkYXRvcnMubWF4KG1heGltdW0pKTtcbiAgICAgIHZhbGlkYXRpb24ubWF4aW11bSA9IG1heGltdW07XG4gICAgfVxuXG4gICAgaWYgKGRlZmluaXRpb24ubXVsdGlwbGVPZikge1xuICAgICAgY29udHJvbFZhbGlkYXRpb24ucHVzaChcbiAgICAgICAgU2NoZW1hVmFsaWRhdG9ycy5tdWx0aXBsZU9mKGRlZmluaXRpb24ubXVsdGlwbGVPZilcbiAgICAgICk7XG4gICAgICB2YWxpZGF0aW9uLm11bHRpcGxlT2YgPSBkZWZpbml0aW9uLm11bHRpcGxlT2Y7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGNvbnRyb2w6IG5ldyBGb3JtQ29udHJvbChkZWZpbml0aW9uLmRlZmF1bHQgfHwgbnVsbCwgY29udHJvbFZhbGlkYXRpb24pLFxuICAgICAgdmFsaWRhdGlvblxuICAgIH07XG4gIH1cblxuICBzdGF0aWMgYm9vbGVhbkNvbnRyb2woXG4gICAgZGVmaW5pdGlvbjogQm9vbGVhblByb3BlcnR5RGVmaW5pdGlvbixcbiAgICByZXF1aXJlZDogYm9vbGVhblxuICApIHtcbiAgICBjb25zdCBjb250cm9sVmFsaWRhdGlvbjogYW55W10gPSBbXTtcbiAgICBjb25zdCB2YWxpZGF0aW9uOiBhbnkgPSB7fTtcblxuICAgIGlmIChyZXF1aXJlZCkge1xuICAgICAgY29udHJvbFZhbGlkYXRpb24ucHVzaChWYWxpZGF0b3JzLnJlcXVpcmVkKTtcbiAgICAgIHZhbGlkYXRpb24ucmVxdWlyZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBjb250cm9sOiBuZXcgRm9ybUNvbnRyb2woZGVmaW5pdGlvbi5kZWZhdWx0IHx8IGZhbHNlLCBjb250cm9sVmFsaWRhdGlvbiksXG4gICAgICB2YWxpZGF0aW9uXG4gICAgfTtcbiAgfVxuXG4gIGJ1aWxkRm9ybShcbiAgICB2YWx1ZT86IGFueSxcbiAgICByZXF1aXJlZDogc3RyaW5nW10gPSBbXSxcbiAgICBiYXNlID0gJy8nLFxuICAgIGFkZElkID0gdHJ1ZVxuICApIHtcbiAgICBjb25zdCBwcm9wZXJ0aWVzID0gdGhpcy5idWlsZFByb3BlcnRpZXMoXG4gICAgICB0aGlzLnNjaGVtYS5wcm9wZXJ0aWVzIHx8IHt9LFxuICAgICAgcmVxdWlyZWQsXG4gICAgICBiYXNlLFxuICAgICAgYWRkSWRcbiAgICApO1xuXG4gICAgdGhpcy5mb3JtID0gcHJvcGVydGllcy5mb3JtO1xuICAgIHRoaXMucG9pbnRlcnMgPSBwcm9wZXJ0aWVzLnBvaW50ZXJzO1xuXG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICB0aGlzLmZvcm0ucGF0Y2hWYWx1ZSh2YWx1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuZm9ybTtcbiAgfVxuXG4gIGJ1aWxkUHJvcGVydGllcyhcbiAgICBwcm9wZXJ0aWVzOiBvYmplY3QsXG4gICAgcmVxdWlyZWQ6IHN0cmluZ1tdID0gW10sXG4gICAgYmFzZSA9ICcvJyxcbiAgICBhZGRJZCA9IHRydWVcbiAgKSB7XG4gICAgY29uc3Qge2Zvcm0sIHBvaW50ZXJzfSA9IFtcbiAgICAgIC4uLk9iamVjdC5lbnRyaWVzKHByb3BlcnRpZXMpLFxuICAgICAgLyoqXG4gICAgICAgKiBBZGQgdGhlIGlkIGZpZWxkIGFzIGEgcHJvcGVydHkgc28gdGhhdFxuICAgICAgICogaXQgY2FuIGJlIGFkZGVkIHRvIHRoZSBmb3JtIGlmIG5lZWRlZFxuICAgICAgICovXG4gICAgICAuLi4oYWRkSWRcbiAgICAgICAgPyBbXG4gICAgICAgICAgICBbXG4gICAgICAgICAgICAgICdpZCcsXG4gICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnc3RyaW5nJ1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICBdXG4gICAgICAgICAgXVxuICAgICAgICA6IFtdKVxuICAgIF0ucmVkdWNlKFxuICAgICAgKGdyb3VwLCBba2V5LCB2YWx1ZV06IFtzdHJpbmcsIGFueV0pID0+IHtcbiAgICAgICAgY29uc3QgaXNSZXF1aXJlZCA9IHJlcXVpcmVkLmluY2x1ZGVzKGtleSk7XG5cbiAgICAgICAgbGV0IHBhcnNlZDoge1xuICAgICAgICAgIGNvbnRyb2w6IGFueTtcbiAgICAgICAgICB2YWxpZGF0aW9uOiBhbnk7XG4gICAgICAgICAgYXJyYXlUeXBlPzogU2NoZW1hVHlwZTtcbiAgICAgICAgICBwcm9wZXJ0aWVzPzogYW55O1xuICAgICAgICAgIHJlcXVpcmVkPzogc3RyaW5nW107XG4gICAgICAgIH07XG5cbiAgICAgICAgc3dpdGNoICh2YWx1ZS50eXBlKSB7XG4gICAgICAgICAgY2FzZSBTY2hlbWFUeXBlLlN0cmluZzpcbiAgICAgICAgICAgIHBhcnNlZCA9IFBhcnNlci5zdHJpbmdDb250cm9sKHZhbHVlLCBpc1JlcXVpcmVkKTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgY2FzZSBTY2hlbWFUeXBlLk51bWJlcjpcbiAgICAgICAgICBjYXNlIFNjaGVtYVR5cGUuSW50ZWdlcjpcbiAgICAgICAgICAgIHBhcnNlZCA9IFBhcnNlci5udW1iZXJDb250cm9sKHZhbHVlLCBpc1JlcXVpcmVkKTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgY2FzZSBTY2hlbWFUeXBlLkJvb2xlYW46XG4gICAgICAgICAgICBwYXJzZWQgPSBQYXJzZXIuYm9vbGVhbkNvbnRyb2wodmFsdWUsIGlzUmVxdWlyZWQpO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICBjYXNlIFNjaGVtYVR5cGUuT2JqZWN0OlxuICAgICAgICAgICAgY29uc3Qgb2JqZWN0UHJvcGVydGllcyA9IHRoaXMuYnVpbGRQcm9wZXJ0aWVzKFxuICAgICAgICAgICAgICAvKipcbiAgICAgICAgICAgICAgICogU3VwcG9ydGluZyBib3RoIHt0eXBlOiAnb2JqZWN0JywgcHJvcGVydGllczoge319IGFuZFxuICAgICAgICAgICAgICAgKiB7dHlwZTogJ29iamVjdCcsIGl0ZW1zOiB7cHJvcGVydGllczoge319fVxuICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgdmFsdWUucHJvcGVydGllcyB8fCAodmFsdWUuaXRlbXMgJiYgdmFsdWUuaXRlbXMucHJvcGVydGllcyA/IHZhbHVlLml0ZW1zLnByb3BlcnRpZXMgOiB7fSksXG4gICAgICAgICAgICAgIHZhbHVlLnJlcXVpcmVkIHx8IHZhbHVlLml0ZW1zICYmIHZhbHVlLml0ZW1zLnJlcXVpcmVkID8gdmFsdWUuaXRlbXMucmVxdWlyZWQgOiBbXSxcbiAgICAgICAgICAgICAgYmFzZSArIGtleSArICcvJyxcbiAgICAgICAgICAgICAgZmFsc2VcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgYWRkZWQgaW4gb2JqZWN0UHJvcGVydGllcy5wb2ludGVycykge1xuICAgICAgICAgICAgICBpZiAob2JqZWN0UHJvcGVydGllcy5wb2ludGVycy5oYXNPd25Qcm9wZXJ0eShhZGRlZCkpIHtcbiAgICAgICAgICAgICAgICAvLyBAdHMtaWdub3JlXG4gICAgICAgICAgICAgICAgZ3JvdXAucG9pbnRlcnNbYWRkZWRdID0gb2JqZWN0UHJvcGVydGllcy5wb2ludGVyc1thZGRlZF07XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcGFyc2VkID0ge1xuICAgICAgICAgICAgICBjb250cm9sOiBvYmplY3RQcm9wZXJ0aWVzLmZvcm0sXG4gICAgICAgICAgICAgIHZhbGlkYXRpb246IHt9XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICBjYXNlIFNjaGVtYVR5cGUuQXJyYXk6XG4gICAgICAgICAgICBwYXJzZWQgPSB0aGlzLmJ1aWxkQXJyYXkoYmFzZSwgdmFsdWUpO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBwb2ludGVyS2V5ID0gYmFzZSArIGtleTtcbiAgICAgICAgY29uc3QgZGVmaW5pdGlvbiA9IHRoaXMuZ2V0RnJvbURlZmluaXRpb25zKHBvaW50ZXJLZXkpIHx8IHt9O1xuXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgZ3JvdXAuZm9ybVtrZXldID0gcGFyc2VkLmNvbnRyb2w7XG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgZ3JvdXAucG9pbnRlcnNbcG9pbnRlcktleV0gPSB7XG4gICAgICAgICAga2V5LFxuICAgICAgICAgIHR5cGU6IHZhbHVlLnR5cGUsXG4gICAgICAgICAgLi4uZGVmaW5pdGlvbi5mb3JtYXRPbkxvYWRcbiAgICAgICAgICAgICYmIHtmb3JtYXRPbkxvYWQ6IHNhZmVFdmFsKGRlZmluaXRpb24uZm9ybWF0T25Mb2FkKX0sXG4gICAgICAgICAgLi4uZGVmaW5pdGlvbi5mb3JtYXRPblNhdmVcbiAgICAgICAgICAgICYmIHtmb3JtYXRPblNhdmU6IHNhZmVFdmFsKGRlZmluaXRpb24uZm9ybWF0T25TYXZlKX0sXG4gICAgICAgICAgLi4uZGVmaW5pdGlvbi5mb3JtYXRPbkNyZWF0ZVxuICAgICAgICAgICAgJiYge2Zvcm1hdE9uQ3JlYXRlOiBzYWZlRXZhbChkZWZpbml0aW9uLmZvcm1hdE9uQ3JlYXRlKX0sXG4gICAgICAgICAgLi4uZGVmaW5pdGlvbi5mb3JtYXRPbkVkaXRcbiAgICAgICAgICAgICYmIHtmb3JtYXRPbkVkaXQ6IHNhZmVFdmFsKGRlZmluaXRpb24uZm9ybWF0T25FZGl0KX0sXG4gICAgICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgICAgIC4uLnBhcnNlZFxuICAgICAgICB9O1xuXG4gICAgICAgIHJldHVybiBncm91cDtcbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGZvcm06IHt9LFxuICAgICAgICBwb2ludGVyczoge31cbiAgICAgIH1cbiAgICApO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHBvaW50ZXJzLFxuICAgICAgZm9ybTogbmV3IEZvcm1Hcm91cChmb3JtKVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHBvaW50ZXJLZXkgTG9va3VwIGtleSBmb3IgdGhlIHBvaW50ZXJcbiAgICogQHBhcmFtIHBvaW50ZXIgRW50aXJlIHBvaW50ZXIgb2JqZWN0IHRoYXQgc2hvdWxkIGJlIHVzZWRcbiAgICogQHBhcmFtIGRlZmluaXRpb25zIEVudGlyZSBkZWZpbml0aW9ucyBvYmplY3QgdGhhdCBzaG91bGQgYmUgdXNlZFxuICAgKiBAcGFyYW0gc2luZ2xlIERlZmluZXMgaWYgdGhlIGZpZWxkIHNob3duIGluIHRoZSBmb3JtIG9yIGluIHRoZSB0YWJsZVxuICAgKiBAcGFyYW0gYXJyYXlSb290IElmIHRoZSBmaWVsZCBpcyBpbiBhbiBhcnJheSB3aGF0IHJvb3QgbG9va3VwIHRvIHVzZVxuICAgKi9cbiAgZmllbGQoXG4gICAgcG9pbnRlcktleTogc3RyaW5nLFxuICAgIHBvaW50ZXI6IFBvaW50ZXIsXG4gICAgZGVmaW5pdGlvbnM6IERlZmluaXRpb25zID0ge30sXG4gICAgc2luZ2xlID0gdHJ1ZSxcbiAgICBhcnJheVJvb3Q/OiBzdHJpbmdcbiAgKTogQ29tcGlsZWRGaWVsZCB7XG5cbiAgICBpZiAoIXBvaW50ZXIpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdQb2ludGVyczogJywgdGhpcy5wb2ludGVycyk7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkbid0IGZpbmQgcG9pbnRlciBmb3IgJHtwb2ludGVyS2V5fS5gKTtcbiAgICB9XG5cbiAgICBjb25zdCB7a2V5LCB0eXBlLCBjb250cm9sLCB2YWxpZGF0aW9ufSA9IHBvaW50ZXI7XG4gICAgY29uc3QgZGVmaW5pdGlvbiA9IHtcbiAgICAgIGxhYmVsOiBrZXksXG4gICAgICAuLi50aGlzLmdldEZyb21EZWZpbml0aW9ucyhwb2ludGVyS2V5LCBkZWZpbml0aW9ucylcbiAgICB9O1xuXG4gICAgaWYgKFxuICAgICAgKFxuICAgICAgICBkZWZpbml0aW9uLmRpc2FibGVPbiAmJlxuICAgICAgICAoXG4gICAgICAgICAgQXJyYXkuaXNBcnJheShkZWZpbml0aW9uLmRpc2FibGVPbikgP1xuICAgICAgICAgICAgZGVmaW5pdGlvbi5kaXNhYmxlT24uaW5jbHVkZXModGhpcy5zdGF0ZSlcbiAgICAgICAgICAgIDogZGVmaW5pdGlvbi5kaXNhYmxlT24gPT09IHRoaXMuc3RhdGVcbiAgICAgICAgKVxuICAgICAgKSB8fFxuICAgICAgKFxuICAgICAgICBkZWZpbml0aW9uLmRpc2FibGVGb3JSb2xlcyAmJlxuICAgICAgICAoXG4gICAgICAgICAgQXJyYXkuaXNBcnJheShkZWZpbml0aW9uLmRpc2FibGVGb3JSb2xlcykgP1xuICAgICAgICAgICAgZGVmaW5pdGlvbi5kaXNhYmxlRm9yUm9sZXMuaW5jbHVkZXModGhpcy5yb2xlKVxuICAgICAgICAgICAgOiBkZWZpbml0aW9uLmRpc2FibGVGb3JSb2xlcyA9PT0gdGhpcy5yb2xlXG4gICAgICAgIClcbiAgICAgIClcbiAgICApIHtcbiAgICAgIGNvbnRyb2wuZGlzYWJsZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFdlIGRvbid0IHNob3cgbGFiZWxzIGluIHRoZSB0YWJsZVxuICAgICAqL1xuICAgIGlmICghc2luZ2xlKSB7XG4gICAgICBkZWZpbml0aW9uLmxhYmVsID0gJyc7XG4gICAgfVxuXG4gICAgaWYgKCFkZWZpbml0aW9uLmNvbXBvbmVudCkge1xuICAgICAgZGVmaW5pdGlvbi5jb21wb25lbnQgPSBzY2hlbWFUb0NvbXBvbmVudCh0eXBlKTtcbiAgICB9XG5cbiAgICAvLyBAdHMtaWdub3JlXG4gICAgY29uc3QgY29tcG9uZW50ID0gQ09NUE9ORU5UX1RZUEVfQ09NUE9ORU5UX01BUFtkZWZpbml0aW9uLmNvbXBvbmVudC50eXBlXSB8fCB0aGlzLmN1c3RvbUZpZWxkc1tkZWZpbml0aW9uLmNvbXBvbmVudC50eXBlXTtcblxuICAgIGlmICghY29tcG9uZW50KSB7XG4gICAgICAvLyBAdHMtaWdub3JlXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkbid0IGZpbmQgYSBjb21wb25lbnQgZGVmaW5lZCBmb3IgdHlwZTogJHtkZWZpbml0aW9uLmNvbXBvbmVudC50eXBlfWApO1xuICAgIH1cblxuICAgIGNvbnN0IHBvcnRhbCA9IG5ldyBDb21wb25lbnRQb3J0YWw8RmllbGRDb21wb25lbnQ8YW55Pj4oXG4gICAgICBjb21wb25lbnQsXG4gICAgICBudWxsLFxuICAgICAgY3JlYXRlQ29tcG9uZW50SW5qZWN0b3IodGhpcy5pbmplY3Rvciwge1xuICAgICAgICBjb250cm9sLFxuICAgICAgICB2YWxpZGF0aW9uLFxuICAgICAgICBzaW5nbGUsXG4gICAgICAgIHBvaW50ZXJzOiB0aGlzLnBvaW50ZXJzLFxuICAgICAgICBmb3JtOiB0aGlzLmZvcm0sXG4gICAgICAgIC4uLmRlZmluaXRpb24sXG4gICAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgICAgLi4uKGRlZmluaXRpb24uY29tcG9uZW50LmNvbmZpZ3VyYXRpb24gfHwge30pXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgcG9pbnRlcjogcG9pbnRlcktleSxcbiAgICAgIGNvbnRyb2wsXG4gICAgICBwb3J0YWwsXG4gICAgICB2YWxpZGF0aW9uLFxuICAgICAgcGxhY2Vob2xkZXI6IGRlZmluaXRpb24ucGxhY2Vob2xkZXIgfHwgJycsXG4gICAgICBsYWJlbDogZGVmaW5pdGlvbi5sYWJlbCxcbiAgICAgIG9ubHlPbjogZGVmaW5pdGlvbi5vbmx5T25cbiAgICB9O1xuICB9XG5cbiAgYWRkQXJyYXlJdGVtKFxuICAgIHBvaW50ZXI6IHN0cmluZyxcbiAgICBsb2FkSG9va3MgPSBmYWxzZSxcbiAgICBwYXJlbnRBcnJheT86IHtcbiAgICAgIGluZGV4OiBudW1iZXIsXG4gICAgICBwb2ludGVyOiBzdHJpbmdcbiAgICB9XG4gICkge1xuICAgIGNvbnN0IHBvaW50ZXJzID0gcGFyZW50QXJyYXkgPyAodGhpcy5wb2ludGVyc1twYXJlbnRBcnJheS5wb2ludGVyXSBhcyBhbnkpLmFycmF5UG9pbnRlcnNbcGFyZW50QXJyYXkuaW5kZXhdIDogdGhpcy5wb2ludGVycztcbiAgICBjb25zdCB0YXJnZXQgPSBwb2ludGVyc1twb2ludGVyXTtcbiAgICBjb25zdCBjb250cm9sID0gcG9pbnRlcnNbcG9pbnRlcl0uY29udHJvbCBhcyBGb3JtQXJyYXk7XG5cbiAgICBpZiAoXG4gICAgICB0YXJnZXQuYXJyYXlUeXBlID09PSBTY2hlbWFUeXBlLkFycmF5IHx8XG4gICAgICB0YXJnZXQuYXJyYXlUeXBlID09PSBTY2hlbWFUeXBlLk9iamVjdFxuICAgICkge1xuICAgICAgY29uc3QgcHJvcGVydGllcyA9IHRoaXMuYnVpbGRQcm9wZXJ0aWVzKFxuICAgICAgICB0YXJnZXQucHJvcGVydGllcyxcbiAgICAgICAgdGFyZ2V0LnJlcXVpcmVkLFxuICAgICAgICBwb2ludGVyICsgJy8nLFxuICAgICAgICBmYWxzZVxuICAgICAgKTtcblxuICAgICAgaWYgKGxvYWRIb29rcykge1xuICAgICAgICB0aGlzLmxvYWRIb29rcyhwcm9wZXJ0aWVzLnBvaW50ZXJzKTtcbiAgICAgIH1cbiAgICAgIC8vIEB0cy1pZ25vcmVcbiAgICAgIHRhcmdldC5hcnJheVBvaW50ZXJzLnVuc2hpZnQocHJvcGVydGllcy5wb2ludGVycyk7XG4gICAgICBjb250cm9sLmNvbnRyb2xzLnVuc2hpZnQocHJvcGVydGllcy5mb3JtKTtcblxuICAgICAgcmV0dXJuIHByb3BlcnRpZXMucG9pbnRlcnM7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGNvbnQgPSBuZXcgRm9ybUNvbnRyb2woJycpO1xuICAgICAgY29udHJvbC5jb250cm9scy51bnNoaWZ0KGNvbnQpO1xuICAgICAgcmV0dXJuIGNvbnQ7XG4gICAgfVxuICB9XG5cbiAgbW92ZUFycmF5SXRlbShcbiAgICBwb2ludGVyOiBzdHJpbmcsXG4gICAgZnJvbUluZGV4OiBudW1iZXIsXG4gICAgdG9JbmRleDogbnVtYmVyLFxuICAgIHBhcmVudEFycmF5Pzoge1xuICAgICAgaW5kZXg6IG51bWJlcixcbiAgICAgIHBvaW50ZXI6IHN0cmluZ1xuICAgIH1cbiAgKSB7XG4gICAgY29uc3QgcG9pbnRlcnMgPSBwYXJlbnRBcnJheSA/ICh0aGlzLnBvaW50ZXJzW3BhcmVudEFycmF5LnBvaW50ZXJdIGFzIGFueSkuYXJyYXlQb2ludGVyc1twYXJlbnRBcnJheS5pbmRleF0gOiB0aGlzLnBvaW50ZXJzO1xuICAgIGNvbnN0IHRhcmdldCA9IHBvaW50ZXJzW3BvaW50ZXJdO1xuICAgIGNvbnN0IGNvbnRyb2wgPSBwb2ludGVyc1twb2ludGVyXS5jb250cm9sIGFzIEZvcm1BcnJheTtcblxuICAgIGlmIChcbiAgICAgIHRhcmdldC5hcnJheVR5cGUgPT09IFNjaGVtYVR5cGUuQXJyYXkgfHxcbiAgICAgIHRhcmdldC5hcnJheVR5cGUgPT09IFNjaGVtYVR5cGUuT2JqZWN0XG4gICAgKSB7XG4gICAgICBtb3ZlSXRlbUluQXJyYXkoXG4gICAgICAgIHRhcmdldC5hcnJheVBvaW50ZXJzIGFzIGFueVtdLFxuICAgICAgICBmcm9tSW5kZXgsXG4gICAgICAgIHRvSW5kZXhcbiAgICAgICk7XG4gICAgfVxuXG4gICAgbW92ZUl0ZW1JbkFycmF5KFxuICAgICAgY29udHJvbC5jb250cm9scyxcbiAgICAgIGZyb21JbmRleCxcbiAgICAgIHRvSW5kZXhcbiAgICApO1xuICB9XG5cbiAgcmVtb3ZlQXJyYXlJdGVtKFxuICAgIHBvaW50ZXI6IHN0cmluZyxcbiAgICBpbmRleDogbnVtYmVyLFxuICAgIHBhcmVudEFycmF5Pzoge1xuICAgICAgaW5kZXg6IG51bWJlcixcbiAgICAgIHBvaW50ZXI6IHN0cmluZ1xuICAgIH1cbiAgKSB7XG4gICAgY29uc3QgcG9pbnRlcnMgPSBwYXJlbnRBcnJheSA/ICh0aGlzLnBvaW50ZXJzW3BhcmVudEFycmF5LnBvaW50ZXJdIGFzIGFueSkuYXJyYXlQb2ludGVyc1twYXJlbnRBcnJheS5pbmRleF0gOiB0aGlzLnBvaW50ZXJzO1xuICAgIHBvaW50ZXJzW3BvaW50ZXJdLmFycmF5UG9pbnRlcnMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAocG9pbnRlcnNbcG9pbnRlcl0uY29udHJvbCBhcyBGb3JtQXJyYXkpLnJlbW92ZUF0KGluZGV4KTtcbiAgfVxuXG4gIGxvYWRIb29rcyhwb2ludGVycyA9IHRoaXMucG9pbnRlcnMpIHtcbiAgICBPYmplY3QudmFsdWVzKHBvaW50ZXJzKS5mb3JFYWNoKGVudHJ5ID0+IHtcbiAgICAgIC8qKlxuICAgICAgICogVE9ETzpcbiAgICAgICAqIEZvciB0aGUgbW9tZW50IGZvcm1hdE9uIG1ldGhvZHMgYXJlXG4gICAgICAgKiBvbmx5IHN1cHBvcnRlZCBvbiBGb3JtQ29udHJvbHMuXG4gICAgICAgKiBXZSBtaWdodCB3YW50IHRvIGV4cGFuZCBvbiB0aGlzIGxhdGVyIG9uLlxuICAgICAgICovXG4gICAgICBpZiAoZW50cnkuY29udHJvbCBpbnN0YW5jZW9mIEZvcm1Db250cm9sICYmIGVudHJ5LmZvcm1hdE9uTG9hZCkge1xuICAgICAgICBjb25zdCBhZGp1c3RlZFZhbHVlID0gZW50cnkuZm9ybWF0T25Mb2FkKGVudHJ5LmNvbnRyb2wudmFsdWUpO1xuXG4gICAgICAgIGlmIChhZGp1c3RlZFZhbHVlICE9PSBlbnRyeS5jb250cm9sLnZhbHVlKSB7XG4gICAgICAgICAgZW50cnkuY29udHJvbC5zZXRWYWx1ZShhZGp1c3RlZFZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHJlU2F2ZUhvb2tzKFxuICAgIGN1cnJlbnRTdGF0ZTogU3RhdGUsXG4gICAgc3RhdGVzVG9Qcm9jZXNzID0gW1N0YXRlLkNyZWF0ZSwgU3RhdGUuRWRpdF0sXG4gICAgcG9pbnRlcnMgPSB0aGlzLnBvaW50ZXJzXG4gICkge1xuXG4gICAgY29uc3QgcHJlU2F2ZURhdGEgPSB0aGlzLmZvcm0uZ2V0UmF3VmFsdWUoKTtcblxuICAgIE9iamVjdC52YWx1ZXMocG9pbnRlcnMpLmZvckVhY2goZW50cnkgPT4ge1xuICAgICAgLyoqXG4gICAgICAgKiBUT0RPOlxuICAgICAgICogRm9yIHRoZSBtb21lbnQgZm9ybWF0T24gbWV0aG9kcyBhcmVcbiAgICAgICAqIG9ubHkgc3VwcG9ydGVkIG9uIEZvcm1Db250cm9scy5cbiAgICAgICAqIFdlIG1pZ2h0IHdhbnQgdG8gZXhwYW5kIG9uIHRoaXMgbGF0ZXIgb24uXG4gICAgICAgKi9cbiAgICAgIGlmIChlbnRyeS5jb250cm9sIGluc3RhbmNlb2YgRm9ybUNvbnRyb2wpIHtcbiAgICAgICAgbGV0IHZhbHVlID0gZW50cnkuY29udHJvbC52YWx1ZTtcblxuICAgICAgICBpZiAoZW50cnkuZm9ybWF0T25TYXZlKSB7XG4gICAgICAgICAgdmFsdWUgPSBlbnRyeS5mb3JtYXRPblNhdmUodmFsdWUsIHByZVNhdmVEYXRhKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzdGF0ZXNUb1Byb2Nlc3MuaW5jbHVkZXMoY3VycmVudFN0YXRlKSkge1xuICAgICAgICAgIGlmIChjdXJyZW50U3RhdGUgPT09IFN0YXRlLkVkaXQgJiYgZW50cnkuZm9ybWF0T25FZGl0KSB7XG4gICAgICAgICAgICB2YWx1ZSA9IGVudHJ5LmZvcm1hdE9uRWRpdCh2YWx1ZSwgcHJlU2F2ZURhdGEpO1xuICAgICAgICAgIH0gZWxzZSBpZiAoZW50cnkuZm9ybWF0T25DcmVhdGUpIHtcbiAgICAgICAgICAgIHZhbHVlID0gZW50cnkuZm9ybWF0T25DcmVhdGUodmFsdWUsIHByZVNhdmVEYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodmFsdWUgIT09IGVudHJ5LmNvbnRyb2wudmFsdWUpIHtcbiAgICAgICAgICBlbnRyeS5jb250cm9sLnNldFZhbHVlKHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoZW50cnkuYXJyYXlQb2ludGVycykge1xuICAgICAgICBlbnRyeS5hcnJheVBvaW50ZXJzLmZvckVhY2goYXJyYXlQb2ludGVycyA9PlxuICAgICAgICAgIHRoaXMucHJlU2F2ZUhvb2tzKGN1cnJlbnRTdGF0ZSwgc3RhdGVzVG9Qcm9jZXNzLCBhcnJheVBvaW50ZXJzKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZ2V0RnJvbURlZmluaXRpb25zKFxuICAgIGtleTogc3RyaW5nLFxuICAgIGRlZmluaXRpb25zOiBEZWZpbml0aW9ucyA9IHRoaXMuZGVmaW5pdGlvbnNcbiAgKSB7XG4gICAgcmV0dXJuIGRlZmluaXRpb25zW1BhcnNlci5zdGFuZGFyZGl6ZUtleShrZXkpXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOlxuICAgKiAtIEhhbmRsZSBjb250YWlucyBjYXNlXG4gICAqIC0gSGFuZGxlIGl0ZW1zIG9yIGNvbnRhaW5zIGFzIGFycmF5IG5vdCBvYmplY3RcbiAgICovXG4gIHByaXZhdGUgYnVpbGRBcnJheShiYXNlOiBzdHJpbmcsIGRlZmluaXRpb246IEFycmF5UHJvcGVydHlEZWZpbml0aW9uKSB7XG4gICAgaWYgKCFkZWZpbml0aW9uLml0ZW1zKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBjb250cm9sOiBuZXcgRm9ybUNvbnRyb2woW10pLFxuICAgICAgICAuLi4oZGVmaW5pdGlvbi5pdGVtc1xuICAgICAgICAgID8ge1xuICAgICAgICAgICAgICBhcnJheVR5cGU6IGRlZmluaXRpb24uaXRlbXMudHlwZSxcbiAgICAgICAgICAgICAgcHJvcGVydGllczogZGVmaW5pdGlvbi5pdGVtcy5wcm9wZXJ0aWVzLFxuICAgICAgICAgICAgICByZXF1aXJlZDogZGVmaW5pdGlvbi5pdGVtcy5yZXF1aXJlZCxcbiAgICAgICAgICAgICAgdmFsaWRhdGlvbjoge31cbiAgICAgICAgICAgIH1cbiAgICAgICAgICA6IHtcbiAgICAgICAgICAgICAgYXJyYXlUeXBlOiBTY2hlbWFUeXBlLlN0cmluZyxcbiAgICAgICAgICAgICAgdmFsaWRhdGlvbjoge31cbiAgICAgICAgICAgIH0pXG4gICAgICB9O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBhcnJheVR5cGU6IGRlZmluaXRpb24uaXRlbXMudHlwZSxcbiAgICAgICAgcHJvcGVydGllczogZGVmaW5pdGlvbi5pdGVtcy5wcm9wZXJ0aWVzLFxuICAgICAgICByZXF1aXJlZDogZGVmaW5pdGlvbi5pdGVtcy5yZXF1aXJlZCxcbiAgICAgICAgdmFsaWRhdGlvbjoge30sXG4gICAgICAgIGNvbnRyb2w6IG5ldyBGb3JtQXJyYXkoW10pLFxuICAgICAgICBhcnJheVBvaW50ZXJzOiBbXVxuICAgICAgfTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==