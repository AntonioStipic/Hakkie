import { ChangeDetectionStrategy, ChangeDetectorRef, Component, Inject, ViewChild } from '@angular/core';
import { FormControl } from '@angular/forms';
import { MatSnackBar } from '@angular/material/snack-bar';
import { DomSanitizer } from '@angular/platform-browser';
import { TranslocoService } from '@ngneat/transloco';
import { from, of, throwError } from 'rxjs';
import { switchMap, tap } from 'rxjs/operators';
import { FieldComponent } from '../../field/field.component';
import { FormBuilderService } from '../../form-builder.service';
import { StorageService } from '../../services/storage.service';
import { COMPONENT_DATA } from '../../utils/create-component-injector';
import { formatFileName } from '../../utils/format-file-name';
import { formatGeneratedImages } from '../../utils/format-generated-images';
import { parseSize } from '../../utils/parse-size';
export class ImageComponent extends FieldComponent {
    constructor(cData, storage, cdr, formBuilderService, transloco, snackBar, domSanitizer) {
        super(cData);
        this.cData = cData;
        this.storage = storage;
        this.cdr = cdr;
        this.formBuilderService = formBuilderService;
        this.transloco = transloco;
        this.snackBar = snackBar;
        this.domSanitizer = domSanitizer;
        this.disInput = false;
    }
    ngOnInit() {
        this.imageUrl = new FormControl(this.cData.control.value);
        this.formBuilderService.saveComponents.push(this);
        this.allowedImageTypes = this.cData.allowedImageTypes || [];
        this.forbiddenImageTypes = this.cData.forbiddenImageTypes || [];
        this.minSizeBytes = this.cData.minSize ? parseSize(this.cData.minSize) : 0;
        this.maxSizeBytes = this.cData.maxSize ? parseSize(this.cData.maxSize) : 0;
    }
    errorSnack(message = 'GENERAL.ERROR', dismiss = 'GENERAL.DISMISS') {
        this.snackBar.open(this.transloco.translate(message), this.transloco.translate(dismiss), {
            panelClass: 'snack-bar-error',
            duration: 5000
        });
    }
    openFileUpload() {
        this.fileEl.nativeElement.click();
    }
    filesImage(event) {
        const el = event.target;
        const image = Array.from(el.files)[0];
        Object.defineProperty(image, 'name', {
            writable: true,
            value: formatFileName(image.name)
        });
        if (!this.allowedImageTypes.includes(image.type) && !!this.allowedImageTypes.length) {
            this.errorSnack('FIELDS.GALLERY.INVALID_IMAGE_FORMAT');
            return throwError('Invalid Image Format');
        }
        if (this.forbiddenImageTypes.includes(image.type)) {
            this.errorSnack('FIELDS.GALLERY.FORBIDDEN_IMAGE_FORMAT');
            return throwError('Forbidden Image Format');
        }
        if (image.size < this.minSizeBytes) {
            this.errorSnack('FIELDS.GALLERY.BELOW_SIZE');
            return throwError('Image below minimal allowed size');
        }
        if (image.size > this.maxSizeBytes && !!this.maxSizeBytes) {
            this.errorSnack('FIELDS.GALLERY.EXCEED_SIZE');
            return throwError('Image exceeding allowed size');
        }
        this.value = image;
        this.disInput = true;
        this.imageUrl.setValue(this.value.name);
        const reader = new FileReader();
        reader.onload = () => {
            this.imageSrc = this.domSanitizer.bypassSecurityTrustResourceUrl(reader.result);
            this.cdr.detectChanges();
        };
        reader.readAsDataURL(this.value);
        el.value = '';
    }
    remove() {
        this.imageUrl.setValue('');
        this.value = null;
        this.disInput = false;
        this.cdr.detectChanges();
    }
    save(moduleId, documentId) {
        if (this.value) {
            if (this.imageUrl.value && this.imageUrl.value !== this.value.name) {
                return of(this.imageUrl.value).pipe(tap(() => this.cData.control.setValue(this.imageUrl.value)));
            }
            else {
                const name = [
                    moduleId,
                    documentId,
                    this.value.name
                ]
                    .join('-');
                return from(this.storage.upload(name, this.value, {
                    contentType: this.value.type,
                    customMetadata: Object.assign({ moduleId,
                        documentId }, (this.cData.generatedImages &&
                        formatGeneratedImages(this.cData.generatedImages)))
                })).pipe(switchMap((res) => res.ref.getDownloadURL()), tap(url => this.cData.control.setValue(url)));
            }
        }
        else {
            this.cData.control.setValue(this.imageUrl.value);
            return of({});
        }
    }
}
ImageComponent.decorators = [
    { type: Component, args: [{
                selector: 'fb-image',
                template: "<mat-form-field appearance=\"outline\" class=\"w-full\">\n  <mat-label>{{(cData.label || '') | transloco}}</mat-label>\n  <input\n    matInput\n    type=\"url\"\n    [placeholder]=\"(cData.placeholder || '') | transloco\"\n    [class.disabled]=\"disInput\"\n    [formControl]=\"imageUrl\">\n  <div matSuffix class=\"fb-image-suffix\">\n    <ng-container *ngIf=\"imageUrl.value\">\n      <div class=\"fb-image-suffix-preview\">\n        <button class=\"fb-image-suffix-preview-button\" mat-icon-button>\n          <mat-icon>visibility</mat-icon>\n        </button>\n        <img class=\"fb-image-suffix-preview-image\" [attr.src]=\"imageSrc || imageUrl.value || value\" [alt]=\"'FIELDS.IMAGE.PREVIEW' | transloco\">\n      </div>\n    </ng-container>\n    <button mat-icon-button *ngIf=\"!imageUrl.value && !cData.preventServerUpload\">\n      <mat-icon (click)=\"openFileUpload()\">perm_media</mat-icon>\n    </button>\n    <button mat-icon-button *ngIf=\"imageUrl.value\">\n      <mat-icon (click)=\"remove()\">highlight_off</mat-icon>\n    </button>\n  </div>\n  <mat-hint *ngIf=\"cData.hint\" [innerHTML]=\"cData.hint | jpSanitize\"></mat-hint>\n</mat-form-field>\n\n<input #file type=\"file\" hidden (change)=\"filesImage($event)\">\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [".fb-image-suffix{display:flex}.fb-image-suffix-preview{display:inline-block;position:relative}.fb-image-suffix-preview-image{-o-object-fit:contain;background:#fff;box-shadow:0 2px 5px 0 rgba(0,0,0,.4);height:200px;max-width:unset;object-fit:contain;opacity:0;position:absolute;right:0;top:100%;transition:.2s;visibility:hidden;width:200px;z-index:2}.fb-image-suffix-preview-button:hover+.fb-image-suffix-preview-image{opacity:1;visibility:visible}"]
            },] }
];
ImageComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [COMPONENT_DATA,] }] },
    { type: StorageService },
    { type: ChangeDetectorRef },
    { type: FormBuilderService },
    { type: TranslocoService },
    { type: MatSnackBar },
    { type: DomSanitizer }
];
ImageComponent.propDecorators = {
    fileEl: [{ type: ViewChild, args: ['file', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1hZ2UuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvZm9ybS1idWlsZGVyL3NyYy9saWIvZmllbGRzL2ltYWdlL2ltYWdlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsdUJBQXVCLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFjLE1BQU0sRUFBVSxTQUFTLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDM0gsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzNDLE9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSw2QkFBNkIsQ0FBQztBQUN4RCxPQUFPLEVBQUMsWUFBWSxFQUFrQixNQUFNLDJCQUEyQixDQUFDO0FBQ3hFLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUMsU0FBUyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSw2QkFBNkIsQ0FBQztBQUMzRCxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUc5RCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFDOUQsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLHVDQUF1QyxDQUFDO0FBQ3JFLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUM1RCxPQUFPLEVBQUMscUJBQXFCLEVBQUMsTUFBTSxxQ0FBcUMsQ0FBQztBQUMxRSxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFpQmpELE1BQU0sT0FBTyxjQUFlLFNBQVEsY0FBeUI7SUFFM0QsWUFDaUMs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QWMsRUFBRSxDQUFDLEVBQ2pELEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUM3QyxDQUFDO2FBQ0g7U0FDRjthQUFNO1lBQ0wsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDakQsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7U0FDZjtJQUNILENBQUM7OztZQTlJRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLFVBQVU7Z0JBQ3BCLGt1Q0FBcUM7Z0JBRXJDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNOzthQUNoRDs7OzRDQUlJLE1BQU0sU0FBQyxjQUFjO1lBeEJsQixjQUFjO1lBWFcsaUJBQWlCO1lBUTFDLGtCQUFrQjtZQUpsQixnQkFBZ0I7WUFGaEIsV0FBVztZQUNYLFlBQVk7OztxQkEyQ2pCLFNBQVMsU0FBQyxNQUFNLEVBQUUsRUFBQyxNQUFNLEVBQUUsSUFBSSxFQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ2hhbmdlRGV0ZWN0b3JSZWYsIENvbXBvbmVudCwgRWxlbWVudFJlZiwgSW5qZWN0LCBPbkluaXQsIFZpZXdDaGlsZH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0Zvcm1Db250cm9sfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQge01hdFNuYWNrQmFyfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9zbmFjay1iYXInO1xuaW1wb3J0IHtEb21TYW5pdGl6ZXIsIFNhZmVSZXNvdXJjZVVybH0gZnJvbSAnQGFuZ3VsYXIvcGxhdGZvcm0tYnJvd3Nlcic7XG5pbXBvcnQge1RyYW5zbG9jb1NlcnZpY2V9IGZyb20gJ0BuZ25lYXQvdHJhbnNsb2NvJztcbmltcG9ydCB7ZnJvbSwgb2YsIHRocm93RXJyb3J9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtzd2l0Y2hNYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtGaWVsZENvbXBvbmVudH0gZnJvbSAnLi4vLi4vZmllbGQvZmllbGQuY29tcG9uZW50JztcbmltcG9ydCB7Rm9ybUJ1aWxkZXJTZXJ2aWNlfSBmcm9tICcuLi8uLi9mb3JtLWJ1aWxkZXIuc2VydmljZSc7XG5pbXBvcnQge0ZpZWxkRGF0YX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9maWVsZC1kYXRhLmludGVyZmFjZSc7XG5pbXBvcnQge0dlbmVyYXRlZEltYWdlfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL2dlbmVyYXRlZC1pbWFnZS5pbnRlcmZhY2UnO1xuaW1wb3J0IHtTdG9yYWdlU2VydmljZX0gZnJvbSAnLi4vLi4vc2VydmljZXMvc3RvcmFnZS5zZXJ2aWNlJztcbmltcG9ydCB7Q09NUE9ORU5UX0RBVEF9IGZyb20gJy4uLy4uL3V0aWxzL2NyZWF0ZS1jb21wb25lbnQtaW5qZWN0b3InO1xuaW1wb3J0IHtmb3JtYXRGaWxlTmFtZX0gZnJvbSAnLi4vLi4vdXRpbHMvZm9ybWF0LWZpbGUtbmFtZSc7XG5pbXBvcnQge2Zvcm1hdEdlbmVyYXRlZEltYWdlc30gZnJvbSAnLi4vLi4vdXRpbHMvZm9ybWF0LWdlbmVyYXRlZC1pbWFnZXMnO1xuaW1wb3J0IHtwYXJzZVNpemV9IGZyb20gJy4uLy4uL3V0aWxzL3BhcnNlLXNpemUnO1xuXG5pbnRlcmZhY2UgSW1hZ2VEYXRhIGV4dGVuZHMgRmllbGREYXRhIHtcbiAgcHJldmVudFNlcnZlclVwbG9hZD86IGJvb2xlYW47XG4gIGdlbmVyYXRlZEltYWdlcz86IEdlbmVyYXRlZEltYWdlW107XG4gIGFsbG93ZWRJbWFnZVR5cGVzPzogc3RyaW5nW107XG4gIGZvcmJpZGRlbkltYWdlVHlwZXM/OiBzdHJpbmdbXTtcbiAgbWluU2l6ZT86IHN0cmluZyB8IG51bWJlcjtcbiAgbWF4U2l6ZT86IHN0cmluZyB8IG51bWJlcjtcbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnZmItaW1hZ2UnLFxuICB0ZW1wbGF0ZVVybDogJy4vaW1hZ2UuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9pbWFnZS5jb21wb25lbnQuc2NzcyddLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaFxufSlcbmV4cG9ydCBjbGFzcyBJbWFnZUNvbXBvbmVudCBleHRlbmRzIEZpZWxkQ29tcG9uZW50PEltYWdlRGF0YT5cbiAgaW1wbGVtZW50cyBPbkluaXQge1xuICBjb25zdHJ1Y3RvcihcbiAgICBASW5qZWN0KENPTVBPTkVOVF9EQVRBKSBwdWJsaWMgY0RhdGE6IEltYWdlRGF0YSxcbiAgICBwcml2YXRlIHN0b3JhZ2U6IFN0b3JhZ2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcml2YXRlIGZvcm1CdWlsZGVyU2VydmljZTogRm9ybUJ1aWxkZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsb2NvOiBUcmFuc2xvY29TZXJ2aWNlLFxuICAgIHByaXZhdGUgc25hY2tCYXI6IE1hdFNuYWNrQmFyLFxuICAgIHByaXZhdGUgZG9tU2FuaXRpemVyOiBEb21TYW5pdGl6ZXJcbiAgKSB7XG4gICAgc3VwZXIoY0RhdGEpO1xuICB9XG5cbiAgQFZpZXdDaGlsZCgnZmlsZScsIHtzdGF0aWM6IHRydWV9KVxuICBmaWxlRWw6IEVsZW1lbnRSZWY8SFRNTElucHV0RWxlbWVudD47XG4gIHZhbHVlOiBGaWxlIHwgbnVsbDtcbiAgaW1hZ2VVcmw6IEZvcm1Db250cm9sO1xuICBkaXNJbnB1dCA9IGZhbHNlO1xuICBpbWFnZVNyYzogU2FmZVJlc291cmNlVXJsO1xuXG4gIGFsbG93ZWRJbWFnZVR5cGVzOiBzdHJpbmdbXTtcbiAgZm9yYmlkZGVuSW1hZ2VUeXBlczogc3RyaW5nW107XG4gIG1pblNpemVCeXRlczogbnVtYmVyO1xuICBtYXhTaXplQnl0ZXM6IG51bWJlcjtcblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmltYWdlVXJsID0gbmV3IEZvcm1Db250cm9sKHRoaXMuY0RhdGEuY29udHJvbC52YWx1ZSk7XG4gICAgdGhpcy5mb3JtQnVpbGRlclNlcnZpY2Uuc2F2ZUNvbXBvbmVudHMucHVzaCh0aGlzKTtcblxuICAgIHRoaXMuYWxsb3dlZEltYWdlVHlwZXMgPSB0aGlzLmNEYXRhLmFsbG93ZWRJbWFnZVR5cGVzIHx8IFtdO1xuICAgIHRoaXMuZm9yYmlkZGVuSW1hZ2VUeXBlcyA9IHRoaXMuY0RhdGEuZm9yYmlkZGVuSW1hZ2VUeXBlcyB8fCBbXTtcbiAgICB0aGlzLm1pblNpemVCeXRlcyA9IHRoaXMuY0RhdGEubWluU2l6ZSA/IHBhcnNlU2l6ZSh0aGlzLmNEYXRhLm1pblNpemUpIDogMDtcbiAgICB0aGlzLm1heFNpemVCeXRlcyA9IHRoaXMuY0RhdGEubWF4U2l6ZSA/IHBhcnNlU2l6ZSh0aGlzLmNEYXRhLm1heFNpemUpIDogMDtcbiAgfVxuXG4gIGVycm9yU25hY2sobWVzc2FnZTogc3RyaW5nID0gJ0dFTkVSQUwuRVJST1InLCBkaXNtaXNzOiBzdHJpbmcgPSAnR0VORVJBTC5ESVNNSVNTJykge1xuICAgIHRoaXMuc25hY2tCYXIub3BlbihcbiAgICAgIHRoaXMudHJhbnNsb2NvLnRyYW5zbGF0ZShtZXNzYWdlKSxcbiAgICAgIHRoaXMudHJhbnNsb2NvLnRyYW5zbGF0ZShkaXNtaXNzKSxcbiAgICAgIHtcbiAgICAgICAgcGFuZWxDbGFzczogJ3NuYWNrLWJhci1lcnJvcicsXG4gICAgICAgIGR1cmF0aW9uOiA1MDAwXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIG9wZW5GaWxlVXBsb2FkKCkge1xuICAgIHRoaXMuZmlsZUVsLm5hdGl2ZUVsZW1lbnQuY2xpY2soKTtcbiAgfVxuXG4gIGZpbGVzSW1hZ2UoZXZlbnQ6IEV2ZW50KSB7XG4gICAgY29uc3QgZWwgPSBldmVudC50YXJnZXQgYXMgSFRNTElucHV0RWxlbWVudDtcbiAgICBjb25zdCBpbWFnZSA9IEFycmF5LmZyb20oZWwuZmlsZXMgYXMgRmlsZUxpc3QpWzBdIGFzIEZpbGU7XG5cbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoaW1hZ2UsICduYW1lJywge1xuICAgICAgd3JpdGFibGU6IHRydWUsXG4gICAgICB2YWx1ZTogZm9ybWF0RmlsZU5hbWUoaW1hZ2UubmFtZSlcbiAgICB9KTtcblxuICAgIGlmICghdGhpcy5hbGxvd2VkSW1hZ2VUeXBlcy5pbmNsdWRlcyhpbWFnZS50eXBlKSAmJiAhIXRoaXMuYWxsb3dlZEltYWdlVHlwZXMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmVycm9yU25hY2soJ0ZJRUxEUy5HQUxMRVJZLklOVkFMSURfSU1BR0VfRk9STUFUJyk7XG4gICAgICByZXR1cm4gdGhyb3dFcnJvcignSW52YWxpZCBJbWFnZSBGb3JtYXQnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5mb3JiaWRkZW5JbWFnZVR5cGVzLmluY2x1ZGVzKGltYWdlLnR5cGUpKSB7XG4gICAgICB0aGlzLmVycm9yU25hY2soJ0ZJRUxEUy5HQUxMRVJZLkZPUkJJRERFTl9JTUFHRV9GT1JNQVQnKTtcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdGb3JiaWRkZW4gSW1hZ2UgRm9ybWF0Jyk7XG4gICAgfVxuXG4gICAgaWYgKGltYWdlLnNpemUgPCB0aGlzLm1pblNpemVCeXRlcykge1xuICAgICAgdGhpcy5lcnJvclNuYWNrKCdGSUVMRFMuR0FMTEVSWS5CRUxPV19TSVpFJyk7XG4gICAgICByZXR1cm4gdGhyb3dFcnJvcignSW1hZ2UgYmVsb3cgbWluaW1hbCBhbGxvd2VkIHNpemUnKTtcbiAgICB9XG5cbiAgICBpZiAoaW1hZ2Uuc2l6ZSA+IHRoaXMubWF4U2l6ZUJ5dGVzICYmICEhdGhpcy5tYXhTaXplQnl0ZXMpIHtcbiAgICAgIHRoaXMuZXJyb3JTbmFjaygnRklFTERTLkdBTExFUlkuRVhDRUVEX1NJWkUnKTtcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdJbWFnZSBleGNlZWRpbmcgYWxsb3dlZCBzaXplJyk7XG4gICAgfVxuXG4gICAgdGhpcy52YWx1ZSA9IGltYWdlO1xuICAgIHRoaXMuZGlzSW5wdXQgPSB0cnVlO1xuICAgIHRoaXMuaW1hZ2VVcmwuc2V0VmFsdWUodGhpcy52YWx1ZS5uYW1lKTtcblxuICAgIGNvbnN0IHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgcmVhZGVyLm9ubG9hZCA9ICgpID0+IHtcbiAgICAgIHRoaXMuaW1hZ2VTcmMgPSB0aGlzLmRvbVNhbml0aXplci5ieXBhc3NTZWN1cml0eVRydXN0UmVzb3VyY2VVcmwoXG4gICAgICAgIHJlYWRlci5yZXN1bHQgYXMgc3RyaW5nXG4gICAgICApO1xuICAgICAgdGhpcy5jZHIuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH07XG4gICAgcmVhZGVyLnJlYWRBc0RhdGFVUkwodGhpcy52YWx1ZSk7XG4gICAgZWwudmFsdWUgPSAnJztcbiAgfVxuXG4gIHJlbW92ZSgpIHtcbiAgICB0aGlzLmltYWdlVXJsLnNldFZhbHVlKCcnKTtcbiAgICB0aGlzLnZhbHVlID0gbnVsbDtcbiAgICB0aGlzLmRpc0lucHV0ID0gZmFsc2U7XG4gICAgdGhpcy5jZHIuZGV0ZWN0Q2hhbmdlcygpO1xuICB9XG5cbiAgc2F2ZShtb2R1bGVJZDogc3RyaW5nLCBkb2N1bWVudElkOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy52YWx1ZSkge1xuICAgICAgaWYgKHRoaXMuaW1hZ2VVcmwudmFsdWUgJiYgdGhpcy5pbWFnZVVybC52YWx1ZSAhPT0gdGhpcy52YWx1ZS5uYW1lKSB7XG4gICAgICAgIHJldHVybiBvZih0aGlzLmltYWdlVXJsLnZhbHVlKS5waXBlKFxuICAgICAgICAgIHRhcCgoKSA9PiB0aGlzLmNEYXRhLmNvbnRyb2wuc2V0VmFsdWUodGhpcy5pbWFnZVVybC52YWx1ZSkpXG4gICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuXG4gICAgICAgIGNvbnN0IG5hbWUgPSBbXG4gICAgICAgICAgbW9kdWxlSWQsXG4gICAgICAgICAgZG9jdW1lbnRJZCxcbiAgICAgICAgICB0aGlzLnZhbHVlLm5hbWVcbiAgICAgICAgXVxuICAgICAgICAgIC5qb2luKCctJyk7XG5cbiAgICAgICAgcmV0dXJuIGZyb20oXG4gICAgICAgICAgdGhpcy5zdG9yYWdlLnVwbG9hZChuYW1lLCB0aGlzLnZhbHVlLCB7XG4gICAgICAgICAgICBjb250ZW50VHlwZTogdGhpcy52YWx1ZS50eXBlLFxuICAgICAgICAgICAgY3VzdG9tTWV0YWRhdGE6IHtcbiAgICAgICAgICAgICAgbW9kdWxlSWQsXG4gICAgICAgICAgICAgIGRvY3VtZW50SWQsXG4gICAgICAgICAgICAgIC4uLih0aGlzLmNEYXRhLmdlbmVyYXRlZEltYWdlcyAmJlxuICAgICAgICAgICAgICAgIGZvcm1hdEdlbmVyYXRlZEltYWdlcyh0aGlzLmNEYXRhLmdlbmVyYXRlZEltYWdlcykpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSlcbiAgICAgICAgKS5waXBlKFxuICAgICAgICAgIHN3aXRjaE1hcCgocmVzOiBhbnkpID0+IHJlcy5yZWYuZ2V0RG93bmxvYWRVUkwoKSksXG4gICAgICAgICAgdGFwKHVybCA9PiB0aGlzLmNEYXRhLmNvbnRyb2wuc2V0VmFsdWUodXJsKSlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5jRGF0YS5jb250cm9sLnNldFZhbHVlKHRoaXMuaW1hZ2VVcmwudmFsdWUpO1xuICAgICAgcmV0dXJuIG9mKHt9KTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==