import { CdkDropList, CdkDropListGroup, moveItemInArray } from '@angular/cdk/drag-drop';
import { ViewportRuler } from '@angular/cdk/overlay';
import { HttpClient } from '@angular/common/http';
import { ChangeDetectionStrategy, ChangeDetectorRef, Component, Inject, Optional, ViewChild } from '@angular/core';
import { MatDialog } from '@angular/material/dialog';
import { MatSnackBar } from '@angular/material/snack-bar';
import { TranslocoService } from '@ngneat/transloco';
import { forkJoin, from, of, throwError } from 'rxjs';
import { catchError, map, switchMap, tap } from 'rxjs/operators';
import { FieldComponent } from '../../field/field.component';
import { FormBuilderService } from '../../form-builder.service';
import { StorageService } from '../../services/storage.service';
import { COMPONENT_DATA } from '../../utils/create-component-injector';
import { formatFileName } from '../../utils/format-file-name';
import { formatGeneratedImages } from '../../utils/format-generated-images';
import { parseSize } from '../../utils/parse-size';
import { STORAGE_URL } from '../../utils/storage-url';
import { switchItemLocations } from '../../utils/switch-item-locations';
import { readFile } from './read-file';
export class GalleryComponent extends FieldComponent {
    constructor(cData, storageUrl, dialog, cdr, http, storage, formBuilderService, viewportRuler, transloco, snackBar) {
        super(cData);
        this.cData = cData;
        this.storageUrl = storageUrl;
        this.dialog = dialog;
        this.cdr = cdr;
        this.http = http;
        this.storage = storage;
        this.formBuilderService = formBuilderService;
        this.viewportRuler = viewportRuler;
        this.transloco = transloco;
        this.snackBar = snackBar;
        this.files = [];
        this.toRemove = [];
    }
    ngOnInit() {
        this.formBuilderService.saveComponents.push(this);
        this.allowedImageTypes = this.cData.allowedImageTypes || [];
        this.forbiddenImageTypes = this.cData.forbiddenImageTypes || [];
        this.minSizeBytes = this.cData.minSize ? parseSize(this.cData.minSize) : 0;
        this.maxSizeBytes = this.cData.maxSize ? parseSize(this.cData.maxSize) : 0;
    }
    ngAfterViewInit() {
        const phElement = this.placeholder.element.nativeElement;
        const { parentElement } = phElement;
        phElement.style.display = 'none';
        parentElement.removeChild(phElement);
    }
    openUploadDialog() {
        this.dialog.open(this.modalTemplate, {
            width: '420px'
        });
    }
    addImage(image) {
        this.http
            .get(image, {
            withCredentials: false,
            responseType: 'blob'
        })
            .pipe(switchMap((blob) => {
            const type = blob.type.split('/')[1].toLowerCase();
            if (!this.allowedImageTypes.includes(type) && !!this.allowedImageTypes.length) {
                return throwError('Invalid Image Format');
            }
            if (this.forbiddenImageTypes.includes(type)) {
                return throwError('Forbidden Image Format');
            }
            if (blob.size < this.minSizeBytes) {
                return throwError('Image below minimal allowed size');
            }
            if (blob.size > this.maxSizeBytes && !!this.maxSizeBytes) {
                return throwError('Image exceeding allowed size');
            }
            return of(blob);
        }), this.formBuilderService.notify({
            error: 'FIELDS.GALLERY.UPLOAD_ERROR',
            success: null
        }))
            .subscribe(res => {
            const urlCreator = window.URL || window.webkitURL;
            const value = this.cData.control.value;
            value.push({
                data: urlCreator.createObjectURL(res),
                live: true
            });
            this.cData.control.setValue(value);
            this.cdr.detectChanges();
        });
    }
    openFileUpload() {
        this.fileEl.nativeElement.click();
    }
    openSortImages() {
        this.dialog.open(this.imagesSort, {
            width: '800px'
        });
    }
    drop(event) {
        const value = this.cData.control.value;
        switchItemLocations(value, event.previousIndex, event.currentIndex);
        this.cData.control.setValue(value);
        this.cdr.detectChanges();
    }
    move(up = false, index) {
        const currentIndex = up ? index - 1 : index + 1;
        const value = this.cData.control.value;
        moveItemInArray(value, index, currentIndex);
        this.cData.control.setValue(value);
        this.cdr.detectChanges();
    }
    errorSnack(message = 'GENERAL.ERROR', dismiss = 'GENERAL.DISMISS') {
        this.snackBar.open(this.transloco.translate(message), this.transloco.translate(dismiss), {
            panelClass: 'snack-bar-error',
            duration: 5000
        });
    }
    filesUploaded(el) {
        const files = Array.from((el instanceof FileList ? el : el.files));
        for (const file of files) {
            Object.defineProperty(file, 'name', {
                writable: true,
                value: formatFileName(file.name)
            });
            const type = file.type.split('/')[1].toLowerCase();
            if (!this.allowedImageTypes.includes(type) && !!this.allowedImageTypes.length) {
                this.errorSnack('FIELDS.GALLERY.INVALID_IMAGE_FORMAT');
                return throwError('Invalid Image Format');
            }
            if (this.forbiddenImageTypes.includes(type)) {
                this.errorSnack('FIELDS.GALLERY.FORBIDDEN_IMAGE_FORMAT');
                return throwError('Forbidden Image Format');
            }
            if (file.size < this.minSizeBytes) {
                this.errorSnack('FIELDS.GALLERY.BELOW_SIZE');
                return throwError('Image below minimal allowed size');
            }
            if (file.size > this.maxSizeBytes && !!this.maxSizeBytes) {
                this.errorSnack('FIELDS.GALLERY.EXCEED_SIZE');
                return throwError('Image exceeding allowed size');
            }
        }
        forkJoin(files.map(file => readFile(file).pipe(map(data => ({
            data,
            pushToLive: file,
            live: false
        }))))).subscribe(fls => {
            const value = this.cData.control.value;
            value.push(...fls);
            this.cData.control.setValue(value);
            if (!(el instanceof FileList)) {
                el.value = '';
            }
            this.cdr.detectChanges();
        }, () => {
            if (!(el instanceof FileList)) {
                el.value = '';
            }
        });
    }
    removeImage(index, item) {
        if (item.live && item.data.includes(this.storageUrl)) {
            this.toRemove.push(item.data);
        }
        this.cData.control.value.splice(index, 1);
    }
    sortDrop(event) {
        const value = this.cData.control.value;
        moveItemInArray(value, event.previousIndex, event.currentIndex);
        this.cData.control.setValue(value);
    }
    /**
     * Drag and Drop
     */
    dragMoved(e) {
        const point = this.getPointerPositionOnPage(e.event);
        this.listGroup._items.forEach(dropList => {
            if (__isInsideDropListClientRect(dropList, point.x, point.y)) {
                this.activeContainer = dropList;
                return;
            }
        });
    }
    dropListDropped() {
        if (!this.target) {
            return;
        }
        const phElement = this.placeholder.element.nativeElement;
        const parent = phElement.parentElement;
        phElement.style.display = 'none';
        const { element } = this.source;
        parent.removeChild(phElement);
        parent.appendChild(phElement);
        parent.insertBefore(element.nativeElement, parent.children[this.sourceIndex]);
        this.target = null;
        this.source = null;
        if (this.sourceIndex !== this.targetIndex) {
            const value = this.cData.control.value;
            moveItemInArray(value, this.sourceIndex, this.targetIndex);
            this.cData.control.setValue(value);
        }
    }
    /** Determines the point of the page that was touched by the user. */
    getPointerPositionOnPage(event) {
        // `touches` will be empty for start/end events so we have to fall back to `changedTouches`.
        const point = __isTouchEvent(event) ? (event.touches[0] || event.changedTouches[0]) : event;
        const scrollPosition = this.viewportRuler.getViewportScrollPosition();
        return {
            x: point.pageX - scrollPosition.left,
            y: point.pageY - scrollPosition.top
        };
    }
    /**
     * Executes all uploads/removes to persist
     * the changes on server
     */
    save(moduleId, documentId) {
        if (!this.toRemove.length &&
            !this.cData.control.value ||
            !this.cData.control.value.find((val) => !val.live)) {
            return of([]);
        }
        return forkJoin([
            ...this.toRemove.map(file => from(this.storage.storage.refFromURL(file).delete()).pipe(
            /**
             * Dont' fail if files didn't delete
             */
            catchError(() => of([])))),
            ...this.cData.control.value.reduce((acc, cur) => {
                if (cur.live !== undefined && !cur.live) {
                    const name = [
                        moduleId,
                        documentId,
                        cur.pushToLive.name
                    ]
                        .join('-');
                    acc.push(from(this.storage.upload(name, cur.pushToLive, {
                        contentType: cur.pushToLive.type,
                        customMetadata: Object.assign({ moduleId,
                            documentId }, this.cData.generatedImages &&
                            formatGeneratedImages(this.cData.generatedImages))
                    })).pipe(switchMap((task) => task.ref.getDownloadURL()), tap(url => {
                        cur.data = url;
                    })));
                }
                else {
                    acc.push(cur);
                }
                return acc;
            }, [])
        ]).pipe(tap(() => this.cData.control.setValue(this.cData.control.value.map((item) => (item.data ? item.data : item)))));
    }
}
GalleryComponent.decorators = [
    { type: Component, args: [{
                selector: 'fb-gallery',
                template: "<p class=\"fs-small fg-secondary\" *ngIf=\"cData.label\">{{(cData.label || '') | transloco}}</p>\n\n<div class=\"fb-gallery\" fbDropzone (dropped)=\"filesUploaded($event)\">\n  <div class=\"ta-center p-y-l\">\n    <button mat-button *ngIf=\"cData.allowUrl\" (click)=\"openUploadDialog()\">{{'FIELDS.GALLERY.ENTER_URL' | transloco}}</button>\n    <button mat-button *ngIf=\"cData.allowServerUpload\" (click)=\"openFileUpload()\">{{'FIELDS.GALLERY.CHOOSE_FILES' | transloco}}</button>\n    <button mat-button *ngIf=\"cData.allowServerUpload\" (click)=\"openSortImages()\">{{'FIELDS.GALLERY.SORT_IMAGES' | transloco}}</button>\n  </div>\n\n  <!--Upload from disk-->\n  <input #file type=\"file\" multiple hidden (change)=\"filesUploaded($event.target)\">\n\n  <!--Uploaded images list-->\n  <ng-container>\n    <div class=\"fb-gallery-list\" cdkDropListGroup>\n\n      <div class=\"fb-gallery-list-placeholder\" cdkDropList (cdkDropListDropped)=\"dropListDropped()\"></div>\n\n      <div\n        cdkDropList\n        class=\"fb-gallery-list-image\"\n        (cdkDropListDropped)=\"dropListDropped()\"\n        *ngFor=\"let val of cData.control.value; index as index\">\n\n        <div cdkDrag (cdkDragMoved)=\"dragMoved($event);\">\n          <img class=\"fb-gallery-list-image-inner\" [src]=\"(val.data || val) | jpSanitize:'resourceUrl'\">\n          <button class=\"fb-gallery-list-image-remove\" type=\"button\" mat-icon-button [matTooltip]=\"'GENERAL.REMOVE' | transloco\" (click)=\"removeImage(index, val)\">\n            <mat-icon>close</mat-icon>\n          </button>\n        </div>\n\n      </div>\n    </div>\n  </ng-container>\n</div>\n\n<!--Uplaod from URL-->\n<ng-template #modal>\n  <mat-dialog-content>\n    <mat-form-field class=\"w-full\" appearance=\"outline\">\n      <mat-label>{{'FIELDS.GALLERY.IMAGE_URL' | transloco}}</mat-label>\n      <input matInput #url>\n    </mat-form-field>\n  </mat-dialog-content>\n\n  <mat-dialog-actions class=\"jc-end\">\n    <button mat-button mat-dialog-close>{{'GENERAL.CANCEL' | transloco}}</button>&nbsp;\n    <button mat-flat-button color=\"primary\" [disabled]=\"!url.value\" (click)=\"addImage(url.value)\" mat-dialog-close>{{'FIELDS.GALLERY.ADD_IMAGE' | transloco}}</button>\n  </mat-dialog-actions>\n</ng-template>\n\n<!--Image sort-->\n<ng-template #imagesSort>\n  <h1 mat-dialog-title>{{'FIELDS.GALLERY.SORT_IMAGES' | transloco}}</h1>\n\n  <mat-dialog-content>\n\n    <div\n      class=\"sort-wrapper\"\n      cdkDropList\n      (cdkDropListDropped)=\"sortDrop($event)\">\n\n      <div class=\"sort-box\" *ngFor=\"let val of cData.control.value; index as index; first as first; last as last;\" cdkDrag>\n        <img class=\"sort-image\" [src]=\"(val.data || val) | jpSanitize:'resourceUrl'\">\n        <div class=\"flex-1\"></div>\n        <div>\n          <button mat-icon-button [disabled]=\"first\" (click)=\"move(true, index)\">\n            <mat-icon>arrow_upward</mat-icon>\n          </button>\n          <button mat-icon-button [disabled]=\"last\" (click)=\"move(false, index)\">\n            <mat-icon>arrow_downward</mat-icon>\n          </button>\n          <button mat-icon-button cdkDragHandle>\n            <mat-icon>drag_indicator</mat-icon>\n          </button>\n        </div>\n      </div>\n\n    </div>\n  </mat-dialog-content>\n</ng-template>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [".fb-gallery{border:1px dashed var(--tertiary);margin-bottom:1.25em;position:relative}.fb-gallery-list{cursor:-webkit-grab;cursor:grab;display:flex;flex-wrap:wrap}.fb-gallery-list-placeholder{border:2px dashed var(--tertiary)}.fb-gallery-list-image,.fb-gallery-list-placeholder{flex-basis:33.33333%;padding-bottom:33.33333%;position:relative;width:33.33333%}.fb-gallery-list-image{background:#eee;border:2px solid #fff}.fb-gallery-list-image-inner,.fb-gallery-list-image>div{height:100%;position:absolute;width:100%}.fb-gallery-list-image-inner{-o-object-fit:contain;left:0;object-fit:contain;top:0}.fb-gallery-list-image-remove{background:#fff;border:1px solid #222;line-height:24px;opacity:0;position:absolute;right:0;top:0;transition:.2s;visibility:hidden}.fb-gallery-list-image:hover .fb-gallery-list-image-remove{opacity:1;visibility:visible}.fb-gallery:before{bottom:0;content:\"Drop To Upload\";display:none;font-size:20px;left:0;margin:auto;position:absolute;right:0;text-align:center;top:0}.fb-gallery.active{background:#ccc;border:3px dashed var(--tertiary)}.fb-gallery.active:before{display:block}.sort-wrapper{background:#fff;border:1px solid #ccc;border-radius:4px;display:block;max-width:100%;min-height:60px;overflow:hidden}.sort-image{-o-object-fit:cover;height:40px;object-fit:cover;width:40px}.sort-box{align-items:center;background:#fff;border-bottom:1px solid #ccc;box-sizing:border-box;color:rgba(0,0,0,.87);display:flex;flex-direction:row;font-size:14px;justify-content:space-between;padding:20px 10px}.sort-box:last-child{border:none}.cdk-drag-preview{border-radius:4px;box-shadow:0 5px 5px -3px rgba(0,0,0,.2),0 8px 10px 1px rgba(0,0,0,.14),0 3px 14px 2px rgba(0,0,0,.12);box-sizing:border-box}.cdk-drag-placeholder{opacity:.3}.cdk-drag-animating,.cdk-drop-list-dragging .sort-box:not(.cdk-drag-placeholder){transition:transform .25s cubic-bezier(0,0,.2,1)}"]
            },] }
];
GalleryComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [COMPONENT_DATA,] }] },
    { type: String, decorators: [{ type: Optional }, { type: Inject, args: [STORAGE_URL,] }] },
    { type: MatDialog },
    { type: ChangeDetectorRef },
    { type: HttpClient },
    { type: StorageService },
    { type: FormBuilderService },
    { type: ViewportRuler },
    { type: TranslocoService },
    { type: MatSnackBar }
];
GalleryComponent.propDecorators = {
    listGroup: [{ type: ViewChild, args: [CdkDropListGroup, { static: true },] }],
    placeholder: [{ type: ViewChild, args: [CdkDropList, { static: true },] }],
    modalTemplate: [{ type: ViewChild, args: ['modal', { static: true },] }],
    imagesSort: [{ type: ViewChild, args: ['imagesSort', { static: true },] }],
    fileEl: [{ type: ViewChild, args: ['file', { static: true },] }]
};
function __indexOf(collection, node) {
    return Array.prototype.indexOf.call(collection, node);
}
/** Determines whether an event is a touch event. */
function __isTouchEvent(event) {
    return event.type.startsWith('touch');
}
function __isInsideDropListClientRect(dropList, x, y) {
    const { top, bottom, left, right } = dropList.element.nativeElement.getBoundingClientRect();
    return y >= top && y <= bottom && x >= left && x <= right;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FsbGVyeS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9mb3JtLWJ1aWxkZXIvc3JjL2xpYi9maWVsZHMvZ2FsbGVyeS9nYWxsZXJ5LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQW9DLFdBQVcsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUMsTUFBTSx3QkFBd0IsQ0FBQztBQUN6SCxPQUFPLEVBQUMsYUFBYSxFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDbkQsT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLHNCQUFzQixDQUFDO0FBQ2hELE9BQU8sRUFFTCx1QkFBdUIsRUFDdkIsaUJBQWlCLEVBQ2pCLFNBQVMsRUFFVCxNQUFNLEVBRU4sUUFBUSxFQUVSLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sMEJBQTBCLENBQUM7QUFDbkQsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLDZCQUE2QixDQUFDO0FBQ3hELE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxRQUFRLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDcEQsT0FBTyxFQUFDLFVBQVUsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQy9ELE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSw2QkFBNkIsQ0FBQztBQUMzRCxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUc5RCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFDOUQsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLHVDQUF1QyxDQUFDO0FBQ3JFLE9BQU8sRUFBQyxjQUFj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QW9EO0FBQ3BELFNBQVMsY0FBYyxDQUFDLEtBQThCO0lBQ3BELE9BQU8sS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDeEMsQ0FBQztBQUVELFNBQVMsNEJBQTRCLENBQUMsUUFBcUIsRUFBRSxDQUFTLEVBQUUsQ0FBUztJQUMvRSxNQUFNLEVBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFDLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMscUJBQXFCLEVBQUUsQ0FBQztJQUMxRixPQUFPLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLE1BQU0sSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUM7QUFDNUQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q2RrRHJhZywgQ2RrRHJhZ0Ryb3AsIENka0RyYWdNb3ZlLCBDZGtEcm9wTGlzdCwgQ2RrRHJvcExpc3RHcm91cCwgbW92ZUl0ZW1JbkFycmF5fSBmcm9tICdAYW5ndWxhci9jZGsvZHJhZy1kcm9wJztcbmltcG9ydCB7Vmlld3BvcnRSdWxlcn0gZnJvbSAnQGFuZ3VsYXIvY2RrL292ZXJsYXknO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gIENvbXBvbmVudCxcbiAgRWxlbWVudFJlZixcbiAgSW5qZWN0LFxuICBPbkluaXQsXG4gIE9wdGlvbmFsLFxuICBUZW1wbGF0ZVJlZixcbiAgVmlld0NoaWxkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtNYXREaWFsb2d9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL2RpYWxvZyc7XG5pbXBvcnQge01hdFNuYWNrQmFyfSBmcm9tICdAYW5ndWxhci9tYXRlcmlhbC9zbmFjay1iYXInO1xuaW1wb3J0IHtUcmFuc2xvY29TZXJ2aWNlfSBmcm9tICdAbmduZWF0L3RyYW5zbG9jbyc7XG5pbXBvcnQge2ZvcmtKb2luLCBmcm9tLCBvZiwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge2NhdGNoRXJyb3IsIG1hcCwgc3dpdGNoTWFwLCB0YXB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7RmllbGRDb21wb25lbnR9IGZyb20gJy4uLy4uL2ZpZWxkL2ZpZWxkLmNvbXBvbmVudCc7XG5pbXBvcnQge0Zvcm1CdWlsZGVyU2VydmljZX0gZnJvbSAnLi4vLi4vZm9ybS1idWlsZGVyLnNlcnZpY2UnO1xuaW1wb3J0IHtGaWVsZERhdGF9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvZmllbGQtZGF0YS5pbnRlcmZhY2UnO1xuaW1wb3J0IHtHZW5lcmF0ZWRJbWFnZX0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9nZW5lcmF0ZWQtaW1hZ2UuaW50ZXJmYWNlJztcbmltcG9ydCB7U3RvcmFnZVNlcnZpY2V9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3N0b3JhZ2Uuc2VydmljZSc7XG5pbXBvcnQge0NPTVBPTkVOVF9EQVRBfSBmcm9tICcuLi8uLi91dGlscy9jcmVhdGUtY29tcG9uZW50LWluamVjdG9yJztcbmltcG9ydCB7Zm9ybWF0RmlsZU5hbWV9IGZyb20gJy4uLy4uL3V0aWxzL2Zvcm1hdC1maWxlLW5hbWUnO1xuaW1wb3J0IHtmb3JtYXRHZW5lcmF0ZWRJbWFnZXN9IGZyb20gJy4uLy4uL3V0aWxzL2Zvcm1hdC1nZW5lcmF0ZWQtaW1hZ2VzJztcbmltcG9ydCB7cGFyc2VTaXplfSBmcm9tICcuLi8uLi91dGlscy9wYXJzZS1zaXplJztcbmltcG9ydCB7U1RPUkFHRV9VUkx9IGZyb20gJy4uLy4uL3V0aWxzL3N0b3JhZ2UtdXJsJztcbmltcG9ydCB7c3dpdGNoSXRlbUxvY2F0aW9uc30gZnJvbSAnLi4vLi4vdXRpbHMvc3dpdGNoLWl0ZW0tbG9jYXRpb25zJztcbmltcG9ydCB7cmVhZEZpbGV9IGZyb20gJy4vcmVhZC1maWxlJztcblxuaW50ZXJmYWNlIEdhbGxlcnlEYXRhIGV4dGVuZHMgRmllbGREYXRhIHtcbiAgYWxsb3dVcmw/OiBib29sZWFuO1xuICBhbGxvd1NlcnZlclVwbG9hZD86IGJvb2xlYW47XG4gIGdlbmVyYXRlZEltYWdlcz86IEdlbmVyYXRlZEltYWdlW107XG4gIGFsbG93ZWRJbWFnZVR5cGVzPzogc3RyaW5nW107XG4gIGZvcmJpZGRlbkltYWdlVHlwZXM/OiBzdHJpbmdbXTtcbiAgbWluU2l6ZT86IHN0cmluZyB8IG51bWJlcjtcbiAgbWF4U2l6ZT86IHN0cmluZyB8IG51bWJlcjtcbn1cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnZmItZ2FsbGVyeScsXG4gIHRlbXBsYXRlVXJsOiAnLi9nYWxsZXJ5LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vZ2FsbGVyeS5jb21wb25lbnQuc2NzcyddLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaFxufSlcbmV4cG9ydCBjbGFzcyBHYWxsZXJ5Q29tcG9uZW50IGV4dGVuZHMgRmllbGRDb21wb25lbnQ8R2FsbGVyeURhdGE+XG4gIGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChDT01QT05FTlRfREFUQSlcbiAgICBwdWJsaWMgY0RhdGE6IEdhbGxlcnlEYXRhLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdChTVE9SQUdFX1VSTClcbiAgICBwcml2YXRlIHN0b3JhZ2VVcmw6IHN0cmluZyxcbiAgICBwcml2YXRlIGRpYWxvZzogTWF0RGlhbG9nLFxuICAgIHByaXZhdGUgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXG4gICAgcHJpdmF0ZSBzdG9yYWdlOiBTdG9yYWdlU2VydmljZSxcbiAgICBwcml2YXRlIGZvcm1CdWlsZGVyU2VydmljZTogRm9ybUJ1aWxkZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgdmlld3BvcnRSdWxlcjogVmlld3BvcnRSdWxlcixcbiAgICBwcml2YXRlIHRyYW5zbG9jbzogVHJhbnNsb2NvU2VydmljZSxcbiAgICBwcml2YXRlIHNuYWNrQmFyOiBNYXRTbmFja0JhclxuICApIHtcbiAgICBzdXBlcihjRGF0YSk7XG4gIH1cblxuICBAVmlld0NoaWxkKENka0Ryb3BMaXN0R3JvdXAsIHtzdGF0aWM6IHRydWV9KVxuICBsaXN0R3JvdXA6IENka0Ryb3BMaXN0R3JvdXA8Q2RrRHJvcExpc3Q+O1xuICBAVmlld0NoaWxkKENka0Ryb3BMaXN0LCB7c3RhdGljOiB0cnVlfSlcbiAgcGxhY2Vob2xkZXI6IENka0Ryb3BMaXN0O1xuICBAVmlld0NoaWxkKCdtb2RhbCcsIHtzdGF0aWM6IHRydWV9KVxuICBtb2RhbFRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+O1xuICBAVmlld0NoaWxkKCdpbWFnZXNTb3J0Jywge3N0YXRpYzogdHJ1ZX0pXG4gIGltYWdlc1NvcnQ6IFRlbXBsYXRlUmVmPGFueT47XG4gIEBWaWV3Q2hpbGQoJ2ZpbGUnLCB7c3RhdGljOiB0cnVlfSlcbiAgZmlsZUVsOiBFbGVtZW50UmVmPEhUTUxJbnB1dEVsZW1lbnQ+O1xuICB0YXJnZXQ6IENka0Ryb3BMaXN0IHwgbnVsbDtcbiAgdGFyZ2V0SW5kZXg6IG51bWJlcjtcbiAgc291cmNlOiBDZGtEcm9wTGlzdCB8IG51bGw7XG4gIHNvdXJjZUluZGV4OiBudW1iZXI7XG4gIGFjdGl2ZUNvbnRhaW5lcjogYW55O1xuICBmaWxlczogRmlsZVtdID0gW107XG4gIHRvUmVtb3ZlOiBhbnlbXSA9IFtdO1xuXG4gIGFsbG93ZWRJbWFnZVR5cGVzOiBzdHJpbmdbXTtcbiAgZm9yYmlkZGVuSW1hZ2VUeXBlczogc3RyaW5nW107XG4gIG1pblNpemVCeXRlczogbnVtYmVyO1xuICBtYXhTaXplQnl0ZXM6IG51bWJlcjtcblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLmZvcm1CdWlsZGVyU2VydmljZS5zYXZlQ29tcG9uZW50cy5wdXNoKHRoaXMpO1xuXG4gICAgdGhpcy5hbGxvd2VkSW1hZ2VUeXBlcyA9IHRoaXMuY0RhdGEuYWxsb3dlZEltYWdlVHlwZXMgfHwgW107XG4gICAgdGhpcy5mb3JiaWRkZW5JbWFnZVR5cGVzID0gdGhpcy5jRGF0YS5mb3JiaWRkZW5JbWFnZVR5cGVzIHx8IFtdO1xuICAgIHRoaXMubWluU2l6ZUJ5dGVzID0gdGhpcy5jRGF0YS5taW5TaXplID8gcGFyc2VTaXplKHRoaXMuY0RhdGEubWluU2l6ZSkgOiAwO1xuICAgIHRoaXMubWF4U2l6ZUJ5dGVzID0gdGhpcy5jRGF0YS5tYXhTaXplID8gcGFyc2VTaXplKHRoaXMuY0RhdGEubWF4U2l6ZSkgOiAwO1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCkge1xuICAgIGNvbnN0IHBoRWxlbWVudCA9IHRoaXMucGxhY2Vob2xkZXIuZWxlbWVudC5uYXRpdmVFbGVtZW50O1xuICAgIGNvbnN0IHtwYXJlbnRFbGVtZW50fSA9IHBoRWxlbWVudCBhcyBhbnk7XG5cbiAgICBwaEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICBwYXJlbnRFbGVtZW50LnJlbW92ZUNoaWxkKHBoRWxlbWVudCk7XG4gIH1cblxuICBvcGVuVXBsb2FkRGlhbG9nKCkge1xuICAgIHRoaXMuZGlhbG9nLm9wZW4odGhpcy5tb2RhbFRlbXBsYXRlLCB7XG4gICAgICB3aWR0aDogJzQyMHB4J1xuICAgIH0pO1xuICB9XG5cbiAgYWRkSW1hZ2UoaW1hZ2U6IHN0cmluZykge1xuICAgIHRoaXMuaHR0cFxuICAgICAgLmdldChpbWFnZSwge1xuICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IGZhbHNlLFxuICAgICAgICByZXNwb25zZVR5cGU6ICdibG9iJ1xuICAgICAgfSlcbiAgICAgIC5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKGJsb2I6IEJsb2IpID0+IHtcbiAgICAgICAgICBjb25zdCB0eXBlID0gYmxvYi50eXBlLnNwbGl0KCcvJylbMV0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICBpZiAoIXRoaXMuYWxsb3dlZEltYWdlVHlwZXMuaW5jbHVkZXModHlwZSkgJiYgISF0aGlzLmFsbG93ZWRJbWFnZVR5cGVzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ0ludmFsaWQgSW1hZ2UgRm9ybWF0Jyk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgaWYgKHRoaXMuZm9yYmlkZGVuSW1hZ2VUeXBlcy5pbmNsdWRlcyh0eXBlKSkge1xuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ0ZvcmJpZGRlbiBJbWFnZSBGb3JtYXQnKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBpZiAoYmxvYi5zaXplIDwgdGhpcy5taW5TaXplQnl0ZXMpIHtcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdJbWFnZSBiZWxvdyBtaW5pbWFsIGFsbG93ZWQgc2l6ZScpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGlmIChibG9iLnNpemUgPiB0aGlzLm1heFNpemVCeXRlcyAmJiAhIXRoaXMubWF4U2l6ZUJ5dGVzKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignSW1hZ2UgZXhjZWVkaW5nIGFsbG93ZWQgc2l6ZScpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBvZihibG9iKTtcbiAgICAgICAgfSksXG4gICAgICAgIHRoaXMuZm9ybUJ1aWxkZXJTZXJ2aWNlLm5vdGlmeSh7XG4gICAgICAgICAgZXJyb3I6ICdGSUVMRFMuR0FMTEVSWS5VUExPQURfRVJST1InLFxuICAgICAgICAgIHN1Y2Nlc3M6IG51bGxcbiAgICAgICAgfSkpXG4gICAgICAuc3Vic2NyaWJlKHJlcyA9PiB7XG4gICAgICAgIGNvbnN0IHVybENyZWF0b3IgPSB3aW5kb3cuVVJMIHx8ICh3aW5kb3cgYXMgYW55KS53ZWJraXRVUkw7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5jRGF0YS5jb250cm9sLnZhbHVlO1xuXG4gICAgICAgIHZhbHVlLnB1c2goe1xuICAgICAgICAgIGRhdGE6IHVybENyZWF0b3IuY3JlYXRlT2JqZWN0VVJMKHJlcyksXG4gICAgICAgICAgbGl2ZTogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmNEYXRhLmNvbnRyb2wuc2V0VmFsdWUodmFsdWUpO1xuICAgICAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gICAgICB9KTtcbiAgfVxuXG4gIG9wZW5GaWxlVXBsb2FkKCkge1xuICAgIHRoaXMuZmlsZUVsLm5hdGl2ZUVsZW1lbnQuY2xpY2soKTtcbiAgfVxuXG4gIG9wZW5Tb3J0SW1hZ2VzKCkge1xuICAgIHRoaXMuZGlhbG9nLm9wZW4odGhpcy5pbWFnZXNTb3J0LCB7XG4gICAgICB3aWR0aDogJzgwMHB4J1xuICAgIH0pO1xuICB9XG5cbiAgZHJvcChldmVudDogQ2RrRHJhZ0Ryb3A8c3RyaW5nW10+KSB7XG4gICAgY29uc3QgdmFsdWUgPSB0aGlzLmNEYXRhLmNvbnRyb2wudmFsdWU7XG4gICAgc3dpdGNoSXRlbUxvY2F0aW9ucyh2YWx1ZSwgZXZlbnQucHJldmlvdXNJbmRleCwgZXZlbnQuY3VycmVudEluZGV4KTtcbiAgICB0aGlzLmNEYXRhLmNvbnRyb2wuc2V0VmFsdWUodmFsdWUpO1xuICAgIHRoaXMuY2RyLmRldGVjdENoYW5nZXMoKTtcbiAgfVxuXG4gIG1vdmUodXAgPSBmYWxzZSwgaW5kZXg6IG51bWJlcikge1xuICAgIGNvbnN0IGN1cnJlbnRJbmRleCA9IHVwID8gaW5kZXggLSAxIDogaW5kZXggKyAxO1xuICAgIGNvbnN0IHZhbHVlID0gdGhpcy5jRGF0YS5jb250cm9sLnZhbHVlO1xuICAgIG1vdmVJdGVtSW5BcnJheSh2YWx1ZSwgaW5kZXgsIGN1cnJlbnRJbmRleCk7XG4gICAgdGhpcy5jRGF0YS5jb250cm9sLnNldFZhbHVlKHZhbHVlKTtcbiAgICB0aGlzLmNkci5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBlcnJvclNuYWNrKG1lc3NhZ2U6IHN0cmluZyA9ICdHRU5FUkFMLkVSUk9SJywgZGlzbWlzczogc3RyaW5nID0gJ0dFTkVSQUwuRElTTUlTUycpIHtcbiAgICB0aGlzLnNuYWNrQmFyLm9wZW4oXG4gICAgICB0aGlzLnRyYW5zbG9jby50cmFuc2xhdGUobWVzc2FnZSksXG4gICAgICB0aGlzLnRyYW5zbG9jby50cmFuc2xhdGUoZGlzbWlzcyksXG4gICAgICB7XG4gICAgICAgIHBhbmVsQ2xhc3M6ICdzbmFjay1iYXItZXJyb3InLFxuICAgICAgICBkdXJhdGlvbjogNTAwMFxuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBmaWxlc1VwbG9hZGVkKGVsOiBIVE1MSW5wdXRFbGVtZW50IHwgRmlsZUxpc3QpIHtcbiAgICBjb25zdCBmaWxlcyA9IEFycmF5LmZyb20oKGVsIGluc3RhbmNlb2YgRmlsZUxpc3QgPyBlbCA6IGVsLmZpbGVzKSBhcyBGaWxlTGlzdCk7XG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZmlsZSwgJ25hbWUnLCB7XG4gICAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgICB2YWx1ZTogZm9ybWF0RmlsZU5hbWUoZmlsZS5uYW1lKVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHR5cGUgPSBmaWxlLnR5cGUuc3BsaXQoJy8nKVsxXS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICBpZiAoIXRoaXMuYWxsb3dlZEltYWdlVHlwZXMuaW5jbHVkZXModHlwZSkgJiYgISF0aGlzLmFsbG93ZWRJbWFnZVR5cGVzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLmVycm9yU25hY2soJ0ZJRUxEUy5HQUxMRVJZLklOVkFMSURfSU1BR0VfRk9STUFUJyk7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdJbnZhbGlkIEltYWdlIEZvcm1hdCcpO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5mb3JiaWRkZW5JbWFnZVR5cGVzLmluY2x1ZGVzKHR5cGUpKSB7XG4gICAgICAgIHRoaXMuZXJyb3JTbmFjaygnRklFTERTLkdBTExFUlkuRk9SQklEREVOX0lNQUdFX0ZPUk1BVCcpO1xuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcignRm9yYmlkZGVuIEltYWdlIEZvcm1hdCcpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZmlsZS5zaXplIDwgdGhpcy5taW5TaXplQnl0ZXMpIHtcbiAgICAgICAgdGhpcy5lcnJvclNuYWNrKCdGSUVMRFMuR0FMTEVSWS5CRUxPV19TSVpFJyk7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdJbWFnZSBiZWxvdyBtaW5pbWFsIGFsbG93ZWQgc2l6ZScpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZmlsZS5zaXplID4gdGhpcy5tYXhTaXplQnl0ZXMgJiYgISF0aGlzLm1heFNpemVCeXRlcykge1xuICAgICAgICB0aGlzLmVycm9yU25hY2soJ0ZJRUxEUy5HQUxMRVJZLkVYQ0VFRF9TSVpFJyk7XG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdJbWFnZSBleGNlZWRpbmcgYWxsb3dlZCBzaXplJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9ya0pvaW4oXG4gICAgICBmaWxlcy5tYXAoZmlsZSA9PlxuICAgICAgICByZWFkRmlsZShmaWxlKS5waXBlKFxuICAgICAgICAgIG1hcChkYXRhID0+ICh7XG4gICAgICAgICAgICBkYXRhLFxuICAgICAgICAgICAgcHVzaFRvTGl2ZTogZmlsZSxcbiAgICAgICAgICAgIGxpdmU6IGZhbHNlXG4gICAgICAgICAgfSkpXG4gICAgICAgIClcbiAgICAgIClcbiAgICApLnN1YnNjcmliZShcbiAgICAgIGZscyA9PiB7XG4gICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5jRGF0YS5jb250cm9sLnZhbHVlO1xuICAgICAgICB2YWx1ZS5wdXNoKC4uLmZscyk7XG4gICAgICAgIHRoaXMuY0RhdGEuY29udHJvbC5zZXRWYWx1ZSh2YWx1ZSk7XG5cbiAgICAgICAgaWYgKCEoZWwgaW5zdGFuY2VvZiBGaWxlTGlzdCkpIHtcbiAgICAgICAgICBlbC52YWx1ZSA9ICcnO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jZHIuZGV0ZWN0Q2hhbmdlcygpO1xuICAgICAgfSxcbiAgICAgICgpID0+IHtcbiAgICAgICAgaWYgKCEoZWwgaW5zdGFuY2VvZiBGaWxlTGlzdCkpIHtcbiAgICAgICAgICBlbC52YWx1ZSA9ICcnO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHJlbW92ZUltYWdlKGluZGV4OiBudW1iZXIsIGl0ZW06IGFueSkge1xuICAgIGlmIChpdGVtLmxpdmUgJiYgaXRlbS5kYXRhLmluY2x1ZGVzKHRoaXMuc3RvcmFnZVVybCkpIHtcbiAgICAgIHRoaXMudG9SZW1vdmUucHVzaChpdGVtLmRhdGEpO1xuICAgIH1cblxuICAgIHRoaXMuY0RhdGEuY29udHJvbC52YWx1ZS5zcGxpY2UoaW5kZXgsIDEpO1xuICB9XG5cbiAgc29ydERyb3AoZXZlbnQ6IENka0RyYWdEcm9wPHN0cmluZ1tdPikge1xuICAgIGNvbnN0IHZhbHVlID0gdGhpcy5jRGF0YS5jb250cm9sLnZhbHVlO1xuICAgIG1vdmVJdGVtSW5BcnJheSh2YWx1ZSwgZXZlbnQucHJldmlvdXNJbmRleCwgZXZlbnQuY3VycmVudEluZGV4KTtcbiAgICB0aGlzLmNEYXRhLmNvbnRyb2wuc2V0VmFsdWUodmFsdWUpO1xuICB9XG5cbiAgLyoqXG4gICAqIERyYWcgYW5kIERyb3BcbiAgICovXG4gIGRyYWdNb3ZlZChlOiBDZGtEcmFnTW92ZSkge1xuICAgIGNvbnN0IHBvaW50ID0gdGhpcy5nZXRQb2ludGVyUG9zaXRpb25PblBhZ2UoZS5ldmVudCk7XG5cbiAgICB0aGlzLmxpc3RHcm91cC5faXRlbXMuZm9yRWFjaChkcm9wTGlzdCA9PiB7XG4gICAgICBpZiAoX19pc0luc2lkZURyb3BMaXN0Q2xpZW50UmVjdChkcm9wTGlzdCwgcG9pbnQueCwgcG9pbnQueSkpIHtcbiAgICAgICAgdGhpcy5hY3RpdmVDb250YWluZXIgPSBkcm9wTGlzdDtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgZHJvcExpc3REcm9wcGVkKCkge1xuICAgIGlmICghdGhpcy50YXJnZXQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwaEVsZW1lbnQgPSB0aGlzLnBsYWNlaG9sZGVyLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICBjb25zdCBwYXJlbnQ6IGFueSA9IHBoRWxlbWVudC5wYXJlbnRFbGVtZW50O1xuXG4gICAgcGhFbGVtZW50LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG5cbiAgICBjb25zdCB7ZWxlbWVudH0gPSB0aGlzLnNvdXJjZSBhcyBhbnk7XG5cbiAgICBwYXJlbnQucmVtb3ZlQ2hpbGQocGhFbGVtZW50KTtcbiAgICBwYXJlbnQuYXBwZW5kQ2hpbGQocGhFbGVtZW50KTtcbiAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGVsZW1lbnQubmF0aXZlRWxlbWVudCwgcGFyZW50LmNoaWxkcmVuW3RoaXMuc291cmNlSW5kZXhdKTtcblxuICAgIHRoaXMudGFyZ2V0ID0gbnVsbDtcbiAgICB0aGlzLnNvdXJjZSA9IG51bGw7XG5cbiAgICBpZiAodGhpcy5zb3VyY2VJbmRleCAhPT0gdGhpcy50YXJnZXRJbmRleCkge1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmNEYXRhLmNvbnRyb2wudmFsdWU7XG4gICAgICBtb3ZlSXRlbUluQXJyYXkodmFsdWUsIHRoaXMuc291cmNlSW5kZXgsIHRoaXMudGFyZ2V0SW5kZXgpO1xuICAgICAgdGhpcy5jRGF0YS5jb250cm9sLnNldFZhbHVlKHZhbHVlKTtcbiAgICB9XG4gIH1cblxuICAvKiogRGV0ZXJtaW5lcyB0aGUgcG9pbnQgb2YgdGhlIHBhZ2UgdGhhdCB3YXMgdG91Y2hlZCBieSB0aGUgdXNlci4gKi9cbiAgZ2V0UG9pbnRlclBvc2l0aW9uT25QYWdlKGV2ZW50OiBNb3VzZUV2ZW50IHwgVG91Y2hFdmVudCkge1xuICAgIC8vIGB0b3VjaGVzYCB3aWxsIGJlIGVtcHR5IGZvciBzdGFydC9lbmQgZXZlbnRzIHNvIHdlIGhhdmUgdG8gZmFsbCBiYWNrIHRvIGBjaGFuZ2VkVG91Y2hlc2AuXG4gICAgY29uc3QgcG9pbnQgPSBfX2lzVG91Y2hFdmVudChldmVudCkgPyAoZXZlbnQudG91Y2hlc1swXSB8fCBldmVudC5jaGFuZ2VkVG91Y2hlc1swXSkgOiBldmVudDtcbiAgICBjb25zdCBzY3JvbGxQb3NpdGlvbiA9IHRoaXMudmlld3BvcnRSdWxlci5nZXRWaWV3cG9ydFNjcm9sbFBvc2l0aW9uKCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgeDogcG9pbnQucGFnZVggLSBzY3JvbGxQb3NpdGlvbi5sZWZ0LFxuICAgICAgeTogcG9pbnQucGFnZVkgLSBzY3JvbGxQb3NpdGlvbi50b3BcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGVzIGFsbCB1cGxvYWRzL3JlbW92ZXMgdG8gcGVyc2lzdFxuICAgKiB0aGUgY2hhbmdlcyBvbiBzZXJ2ZXJcbiAgICovXG4gIHNhdmUobW9kdWxlSWQ6IHN0cmluZywgZG9jdW1lbnRJZDogc3RyaW5nKSB7XG4gICAgaWYgKFxuICAgICAgIXRoaXMudG9SZW1vdmUubGVuZ3RoICYmXG4gICAgICAhdGhpcy5jRGF0YS5jb250cm9sLnZhbHVlIHx8XG4gICAgICAhdGhpcy5jRGF0YS5jb250cm9sLnZhbHVlLmZpbmQoKHZhbDogYW55KSA9PiAhdmFsLmxpdmUpXG4gICAgKSB7XG4gICAgICByZXR1cm4gb2YoW10pO1xuICAgIH1cblxuICAgIHJldHVybiBmb3JrSm9pbihbXG4gICAgICAuLi50aGlzLnRvUmVtb3ZlLm1hcChmaWxlID0+XG4gICAgICAgIGZyb20odGhpcy5zdG9yYWdlLnN0b3JhZ2UucmVmRnJvbVVSTChmaWxlKS5kZWxldGUoKSkucGlwZShcbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiBEb250JyBmYWlsIGlmIGZpbGVzIGRpZG4ndCBkZWxldGVcbiAgICAgICAgICAgKi9cbiAgICAgICAgICBjYXRjaEVycm9yKCgpID0+IG9mKFtdKSlcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIC4uLnRoaXMuY0RhdGEuY29udHJvbC52YWx1ZS5yZWR1Y2UoKGFjYzogYW55W10sIGN1cjogYW55KSA9PiB7XG4gICAgICAgIGlmIChjdXIubGl2ZSAhPT0gdW5kZWZpbmVkICYmICFjdXIubGl2ZSkge1xuXG4gICAgICAgICAgY29uc3QgbmFtZSA9IFtcbiAgICAgICAgICAgIG1vZHVsZUlkLFxuICAgICAgICAgICAgZG9jdW1lbnRJZCxcbiAgICAgICAgICAgIGN1ci5wdXNoVG9MaXZlLm5hbWVcbiAgICAgICAgICBdXG4gICAgICAgICAgICAuam9pbignLScpO1xuXG4gICAgICAgICAgYWNjLnB1c2goXG4gICAgICAgICAgICBmcm9tKFxuICAgICAgICAgICAgICB0aGlzLnN0b3JhZ2UudXBsb2FkKG5hbWUsIGN1ci5wdXNoVG9MaXZlLCB7XG4gICAgICAgICAgICAgICAgY29udGVudFR5cGU6IGN1ci5wdXNoVG9MaXZlLnR5cGUsXG4gICAgICAgICAgICAgICAgY3VzdG9tTWV0YWRhdGE6IHtcbiAgICAgICAgICAgICAgICAgIG1vZHVsZUlkLFxuICAgICAgICAgICAgICAgICAgZG9jdW1lbnRJZCxcbiAgICAgICAgICAgICAgICAgIC4uLnRoaXMuY0RhdGEuZ2VuZXJhdGVkSW1hZ2VzICYmXG4gICAgICAgICAgICAgICAgICBmb3JtYXRHZW5lcmF0ZWRJbWFnZXModGhpcy5jRGF0YS5nZW5lcmF0ZWRJbWFnZXMpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKS5waXBlKFxuICAgICAgICAgICAgICBzd2l0Y2hNYXAoKHRhc2s6IGFueSkgPT4gdGFzay5yZWYuZ2V0RG93bmxvYWRVUkwoKSksXG4gICAgICAgICAgICAgIHRhcCh1cmwgPT4ge1xuICAgICAgICAgICAgICAgIGN1ci5kYXRhID0gdXJsO1xuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYWNjLnB1c2goY3VyKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LCBbXSlcbiAgICBdKS5waXBlKFxuICAgICAgdGFwKCgpID0+XG4gICAgICAgIHRoaXMuY0RhdGEuY29udHJvbC5zZXRWYWx1ZShcbiAgICAgICAgICB0aGlzLmNEYXRhLmNvbnRyb2wudmFsdWUubWFwKChpdGVtOiBhbnkpID0+IChpdGVtLmRhdGEgPyBpdGVtLmRhdGEgOiBpdGVtKSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG4gIH1cbn1cblxuZnVuY3Rpb24gX19pbmRleE9mKGNvbGxlY3Rpb246IGFueSwgbm9kZTogYW55KSB7XG4gIHJldHVybiBBcnJheS5wcm90b3R5cGUuaW5kZXhPZi5jYWxsKGNvbGxlY3Rpb24sIG5vZGUpO1xufVxuXG4vKiogRGV0ZXJtaW5lcyB3aGV0aGVyIGFuIGV2ZW50IGlzIGEgdG91Y2ggZXZlbnQuICovXG5mdW5jdGlvbiBfX2lzVG91Y2hFdmVudChldmVudDogTW91c2VFdmVudCB8IFRvdWNoRXZlbnQpOiBldmVudCBpcyBUb3VjaEV2ZW50IHtcbiAgcmV0dXJuIGV2ZW50LnR5cGUuc3RhcnRzV2l0aCgndG91Y2gnKTtcbn1cblxuZnVuY3Rpb24gX19pc0luc2lkZURyb3BMaXN0Q2xpZW50UmVjdChkcm9wTGlzdDogQ2RrRHJvcExpc3QsIHg6IG51bWJlciwgeTogbnVtYmVyKSB7XG4gIGNvbnN0IHt0b3AsIGJvdHRvbSwgbGVmdCwgcmlnaHR9ID0gZHJvcExpc3QuZWxlbWVudC5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICByZXR1cm4geSA+PSB0b3AgJiYgeSA8PSBib3R0b20gJiYgeCA+PSBsZWZ0ICYmIHggPD0gcmlnaHQ7XG59XG4iXX0=