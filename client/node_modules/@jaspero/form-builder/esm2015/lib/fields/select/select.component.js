import { ChangeDetectionStrategy, Component, Inject, Optional } from '@angular/core';
import { BehaviorSubject, of } from 'rxjs';
import { map, startWith, switchMap, tap } from 'rxjs/operators';
import { FieldComponent } from '../../field/field.component';
import { DbService } from '../../services/db.service';
import { ADDITIONAL_CONTEXT } from '../../utils/additional-context';
import { COMPONENT_DATA } from '../../utils/create-component-injector';
import { parseTemplate } from '../../utils/parse-template';
import { ROLE } from '../../utils/role';
import { safeEval } from '../../utils/safe-eval';
export class SelectComponent extends FieldComponent {
    constructor(cData, dbService, role, additionalContext) {
        super(cData);
        this.cData = cData;
        this.dbService = dbService;
        this.role = role;
        this.additionalContext = additionalContext;
        this.loading$ = new BehaviorSubject(true);
    }
    ngOnInit() {
        if (this.cData.populate) {
            const populate = this.cData.populate;
            const mapResults = populate.mapResults ? safeEval(populate.mapResults) : null;
            const documentsMethod = (query) => {
                this.loading$.next(true);
                if (!query) {
                    this.loading$.next(false);
                    return of([]);
                }
                if (query.filter && typeof query.filter === 'string') {
                    return this.dbService.getDocument(query.collection, query.filter)
                        .pipe(map(it => {
                        return (mapResults ? mapResults(it) : [it]).map((doc) => ({
                            value: doc[populate.valueKey || 'id'],
                            name: parseTemplate(populate.nameKey || 'name', doc)
                        }));
                    }), tap(() => this.loading$.next(false)));
                }
                return this.dbService
                    .getDocumentsSimple(query.collection, query.orderBy, query.filter)
                    .pipe(map(docs => {
                    if (mapResults) {
                        docs = mapResults(docs, {
                            fieldData: this.cData,
                            value: this.cData.form.getRawValue(),
                            role: this.role,
                            additionalContext: this.additionalContext
                        });
                    }
                    return docs.map(doc => ({
                        value: doc[populate.valueKey || 'id'],
                        name: parseTemplate(populate.nameKey || 'name', doc)
                    }));
                }), tap(() => this.loading$.next(false)));
            };
            if (populate.dependency) {
                const pointer = this.cData.pointers[populate.dependency.key];
                const gm = safeEval(populate.dependency.method);
                this.dataSet$ = pointer.control.valueChanges
                    .pipe(startWith(pointer.control.value), switchMap(value => documentsMethod(gm(value, {
                    fieldData: this.cData,
                    value: this.cData.form.getRawValue(),
                    role: this.role,
                    additionalContext: this.additionalContext
                }))));
            }
            else {
                let filter = populate.filter;
                if (populate.dynamicFilter) {
                    filter = safeEval(populate.dynamicFilter)({
                        fieldData: this.cData,
                        value: this.cData.form.getRawValue(),
                        role: this.role,
                        additionalContext: this.additionalContext
                    });
                }
                this.dataSet$ = documentsMethod({
                    collection: populate.collection,
                    orderBy: populate.orderBy,
                    filter
                });
            }
        }
        else {
            this.dataSet$ = of(this.cData.dataSet);
        }
    }
}
SelectComponent.decorators = [
    { type: Component, args: [{
                selector: 'fb-select',
                template: "<mat-form-field class=\"w-full\" appearance=\"outline\" [class.mat-form-field-has-hint]=\"cData.hint\">\n  <mat-label>{{(cData.label || '') | transloco}}</mat-label>\n  <mat-select\n    [placeholder]=\"(cData.placeholder || '') | transloco\"\n    [formControl]=\"cData.control\"\n    [multiple]=\"cData.multiple\"\n    [attr.autocomplite]=\"cData.autocomplete || 'off'\">\n    <mat-option *ngFor=\"let data of dataSet$ | async\" [value]=\"data.value\" [disabled]=\"data.disabled\">\n      {{data.name}}\n    </mat-option>\n  </mat-select>\n  <mat-spinner\n    matSuffix\n    *ngIf=\"cData.populate && (loading$ | async)\"\n    [diameter]=\"20\"></mat-spinner>\n  <mat-hint *ngIf=\"cData.hint\" [innerHTML]=\"cData.hint | jpSanitize\"></mat-hint>\n</mat-form-field>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [""]
            },] }
];
SelectComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [COMPONENT_DATA,] }] },
    { type: DbService },
    { type: String, decorators: [{ type: Inject, args: [ROLE,] }] },
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [ADDITIONAL_CONTEXT,] }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2Zvcm0tYnVpbGRlci9zcmMvbGliL2ZpZWxkcy9zZWxlY3Qvc2VsZWN0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsdUJBQXVCLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBVSxRQUFRLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDM0YsT0FBTyxFQUFDLGVBQWUsRUFBYyxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDckQsT0FBTyxFQUFDLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzlELE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSw2QkFBNkIsQ0FBQztBQUkzRCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sMkJBQTJCLENBQUM7QUFDcEQsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFDbEUsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLHVDQUF1QyxDQUFDO0FBQ3JFLE9BQU8sRUFBQyxhQUFhLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUN6RCxPQUFPLEVBQUMsSUFBSSxFQUFDLE1BQU0sa0JBQWtCLENBQUM7QUFDdEMsT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLHVCQUF1QixDQUFDO0FBd0QvQyxNQUFNLE9BQU8sZUFBZ0IsU0FBUSxjQUEwQjtJQUs3RCxZQUNpQyxLQUFpQixFQUN4QyxTQUFvQixFQUVwQixJQUFZLEVBR1osaUJBQXNCO1FBRTlCLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztRQVJrQixVQUFLLEdBQUwsS0FBSyxDQUFZO1FBQ3hDLGNBQVMsR0FBVCxTQUFTLENBQVc7UUFFcEIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQUdaLHNCQUFpQixHQUFqQixpQkFBaUIs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QUFVO29CQUMvQixPQUFPLEVBQUUsUUFBUSxDQUFDLE9BQU87b0JBQ3pCLE1BQU07aUJBQ0EsQ0FBQyxDQUFDO2FBQ1g7U0FDRjthQUFNO1lBQ0wsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFjLENBQUMsQ0FBQztTQUMvQztJQUNILENBQUM7OztZQXZJRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLFdBQVc7Z0JBQ3JCLDB3QkFBc0M7Z0JBRXRDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNOzthQUNoRDs7OzRDQU9JLE1BQU0sU0FBQyxjQUFjO1lBbkVsQixTQUFTO3lDQXFFWixNQUFNLFNBQUMsSUFBSTs0Q0FFWCxRQUFRLFlBQ1IsTUFBTSxTQUFDLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENvbXBvbmVudCwgSW5qZWN0LCBPbkluaXQsIE9wdGlvbmFsfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7QmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBvZn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge21hcCwgc3RhcnRXaXRoLCBzd2l0Y2hNYXAsIHRhcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtGaWVsZENvbXBvbmVudH0gZnJvbSAnLi4vLi4vZmllbGQvZmllbGQuY29tcG9uZW50JztcbmltcG9ydCB7RmllbGREYXRhfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL2ZpZWxkLWRhdGEuaW50ZXJmYWNlJztcbmltcG9ydCB7T3B0aW9ufSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL29wdGlvbi5pbnRlcmZhY2UnO1xuaW1wb3J0IHtXaGVyZUZpbHRlcn0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy93aGVyZS1maWx0ZXIuaW50ZXJmYWNlJztcbmltcG9ydCB7RGJTZXJ2aWNlfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9kYi5zZXJ2aWNlJztcbmltcG9ydCB7QURESVRJT05BTF9DT05URVhUfSBmcm9tICcuLi8uLi91dGlscy9hZGRpdGlvbmFsLWNvbnRleHQnO1xuaW1wb3J0IHtDT01QT05FTlRfREFUQX0gZnJvbSAnLi4vLi4vdXRpbHMvY3JlYXRlLWNvbXBvbmVudC1pbmplY3Rvcic7XG5pbXBvcnQge3BhcnNlVGVtcGxhdGV9IGZyb20gJy4uLy4uL3V0aWxzL3BhcnNlLXRlbXBsYXRlJztcbmltcG9ydCB7Uk9MRX0gZnJvbSAnLi4vLi4vdXRpbHMvcm9sZSc7XG5pbXBvcnQge3NhZmVFdmFsfSBmcm9tICcuLi8uLi91dGlscy9zYWZlLWV2YWwnO1xuXG5pbnRlcmZhY2UgUG9wdWxhdGUge1xuICBjb2xsZWN0aW9uPzogc3RyaW5nO1xuICBuYW1lS2V5Pzogc3RyaW5nO1xuICB2YWx1ZUtleT86IHN0cmluZztcbiAgb3JkZXJCeT86IHN0cmluZztcblxuICAvKipcbiAgICogQSBtZXRob2QgZm9yIG1hcHBpbmcgYWxsIG9mIHRoZSByZXN1bHRzXG4gICAqIChpdGVtczogVFtdKSA9PiBhbnlbXVxuICAgKi9cbiAgbWFwUmVzdWx0cz86IHN0cmluZztcblxuICAvKipcbiAgICogSWYgYSBmaWx0ZXIgaXMgYSBzdHJpbmdcbiAgICogaXQgcmVwcmVzZW50cyB0aGUgaWQgb2YgdGhlIGRvY3VtZW50XG4gICAqL1xuICBmaWx0ZXI/OiBXaGVyZUZpbHRlciB8IHN0cmluZztcblxuICAvKipcbiAgICogQSBzdHJpbmdpZmllZCBmdW5jdGlvbiB0aGF0IHJlY2VpdmVzXG4gICAqIGFuIG9iamVjdCB3aXRoIHtmaWVsZERhdGE6IFNlbGVjdERhdGEsIHZhbHVlOiBmb3JtLmdldFJhd1ZhbHVlKCksIHJvbGU6IHN0cmluZywgYWRkaXRpb25hbENvbnRleHQ/OiBhbnl9XG4gICAqIGFuZCBzaG91bGQgcmV0dXJuIGEgV2hlcmVGaWx0ZXIuXG4gICAqIFRoaXMgZG9lc24ndCB3b3JrIGluIGNvbWJpbmF0aW9uIHdpdGggdGhlIGRlcGVuZGVuY3kgcHJvcGVydHlcbiAgICovXG4gIGR5bmFtaWNGaWx0ZXI/OiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFVzZSB0aGlzIHByb3BlcnR5IGlmIHRoZSBmaWVsZCBkZXBlbmRzIG9uIGNoYW5nZXNcbiAgICogb2YgYSBkaWZmZXJlbnQgZmllbGQgaW4gdGhlIGZvcm1cbiAgICovXG4gIGRlcGVuZGVuY3k/OiB7XG4gICAga2V5OiBzdHJpbmc7XG5cbiAgICAvKipcbiAgICAgKiBBIG1ldGhvZCBmb3IgZGVmaW5pbmcgcXVlcnkgZHluYW1pY2FsbHlcbiAgICAgKiAodmFsdWUpID0+IHtjb2xsZWN0aW9uOiBzdHJpbmc7IG9yZGVyQnk6IHN0cmluZzsgZmlsdGVyOiBXaGVyZUZpbHRlciB8IHN0cmluZ31cbiAgICAgKi9cbiAgICBtZXRob2Q6IHN0cmluZztcbiAgfTtcbn1cblxuaW50ZXJmYWNlIFNlbGVjdERhdGEgZXh0ZW5kcyBGaWVsZERhdGEge1xuICBkYXRhU2V0PzogT3B0aW9uW107XG4gIG11bHRpcGxlPzogYm9vbGVhbjtcbiAgcG9wdWxhdGU/OiBQb3B1bGF0ZTtcbiAgYXV0b2NvbXBsZXRlPzogc3RyaW5nO1xufVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdmYi1zZWxlY3QnLFxuICB0ZW1wbGF0ZVVybDogJy4vc2VsZWN0LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vc2VsZWN0LmNvbXBvbmVudC5zY3NzJ10sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXG59KVxuZXhwb3J0IGNsYXNzIFNlbGVjdENvbXBvbmVudCBleHRlbmRzIEZpZWxkQ29tcG9uZW50PFNlbGVjdERhdGE+XG4gIGltcGxlbWVudHMgT25Jbml0IHtcbiAgZGF0YVNldCQ6IE9ic2VydmFibGU8T3B0aW9uW10+O1xuICBsb2FkaW5nJCA9IG5ldyBCZWhhdmlvclN1YmplY3QodHJ1ZSk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChDT01QT05FTlRfREFUQSkgcHVibGljIGNEYXRhOiBTZWxlY3REYXRhLFxuICAgIHByaXZhdGUgZGJTZXJ2aWNlOiBEYlNlcnZpY2UsXG4gICAgQEluamVjdChST0xFKVxuICAgIHByaXZhdGUgcm9sZTogc3RyaW5nLFxuICAgIEBPcHRpb25hbCgpXG4gICAgQEluamVjdChBRERJVElPTkFMX0NPTlRFWFQpXG4gICAgcHJpdmF0ZSBhZGRpdGlvbmFsQ29udGV4dDogYW55XG4gICkge1xuICAgIHN1cGVyKGNEYXRhKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICh0aGlzLmNEYXRhLnBvcHVsYXRlKSB7XG5cbiAgICAgIGNvbnN0IHBvcHVsYXRlID0gdGhpcy5jRGF0YS5wb3B1bGF0ZSBhcyBQb3B1bGF0ZTtcblxuICAgICAgY29uc3QgbWFwUmVzdWx0cyA9IHBvcHVsYXRlLm1hcFJlc3VsdHMgPyBzYWZlRXZhbChwb3B1bGF0ZS5tYXBSZXN1bHRzKSA6IG51bGw7XG4gICAgICBjb25zdCBkb2N1bWVudHNNZXRob2QgPSAoXG4gICAgICAgIHF1ZXJ5Pzoge1xuICAgICAgICAgIGNvbGxlY3Rpb246IHN0cmluZyxcbiAgICAgICAgICBvcmRlckJ5OiBzdHJpbmcsXG4gICAgICAgICAgZmlsdGVyOiBXaGVyZUZpbHRlciB8IHN0cmluZ1xuICAgICAgICB9XG4gICAgICApID0+IHtcblxuICAgICAgICB0aGlzLmxvYWRpbmckLm5leHQodHJ1ZSk7XG5cbiAgICAgICAgaWYgKCFxdWVyeSkge1xuICAgICAgICAgIHRoaXMubG9hZGluZyQubmV4dChmYWxzZSk7XG4gICAgICAgICAgcmV0dXJuIG9mKFtdKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChxdWVyeS5maWx0ZXIgJiYgdHlwZW9mIHF1ZXJ5LmZpbHRlciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5kYlNlcnZpY2UuZ2V0RG9jdW1lbnQoXG4gICAgICAgICAgICBxdWVyeS5jb2xsZWN0aW9uLFxuICAgICAgICAgICAgcXVlcnkuZmlsdGVyXG4gICAgICAgICAgKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgIG1hcChpdCA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIChtYXBSZXN1bHRzID8gbWFwUmVzdWx0cyhpdCkgOiBbaXRdKS5tYXAoKGRvYzogYW55KSA9PiAoe1xuICAgICAgICAgICAgICAgICAgdmFsdWU6IGRvY1twb3B1bGF0ZS52YWx1ZUtleSB8fCAnaWQnXSxcbiAgICAgICAgICAgICAgICAgIG5hbWU6IHBhcnNlVGVtcGxhdGUoXG4gICAgICAgICAgICAgICAgICAgIHBvcHVsYXRlLm5hbWVLZXkgfHwgJ25hbWUnLFxuICAgICAgICAgICAgICAgICAgICBkb2NcbiAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICB0YXAoKCkgPT4gdGhpcy5sb2FkaW5nJC5uZXh0KGZhbHNlKSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5kYlNlcnZpY2VcbiAgICAgICAgICAuZ2V0RG9jdW1lbnRzU2ltcGxlKFxuICAgICAgICAgICAgcXVlcnkuY29sbGVjdGlvbixcbiAgICAgICAgICAgIHF1ZXJ5Lm9yZGVyQnksXG4gICAgICAgICAgICBxdWVyeS5maWx0ZXIgYXMgV2hlcmVGaWx0ZXJcbiAgICAgICAgICApXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBtYXAoZG9jcyA9PiB7XG4gICAgICAgICAgICAgIGlmIChtYXBSZXN1bHRzKSB7XG4gICAgICAgICAgICAgICAgZG9jcyA9IG1hcFJlc3VsdHMoZG9jcywge1xuICAgICAgICAgICAgICAgICAgZmllbGREYXRhOiB0aGlzLmNEYXRhLFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IHRoaXMuY0RhdGEuZm9ybS5nZXRSYXdWYWx1ZSgpLFxuICAgICAgICAgICAgICAgICAgcm9sZTogdGhpcy5yb2xlLFxuICAgICAgICAgICAgICAgICAgYWRkaXRpb25hbENvbnRleHQ6IHRoaXMuYWRkaXRpb25hbENvbnRleHRcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgIHJldHVybiBkb2NzLm1hcChkb2MgPT4gKHtcbiAgICAgICAgICAgICAgICB2YWx1ZTogZG9jW3BvcHVsYXRlLnZhbHVlS2V5IHx8ICdpZCddLFxuICAgICAgICAgICAgICAgIG5hbWU6IHBhcnNlVGVtcGxhdGUoXG4gICAgICAgICAgICAgICAgICBwb3B1bGF0ZS5uYW1lS2V5IHx8ICduYW1lJyxcbiAgICAgICAgICAgICAgICAgIGRvY1xuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICB0YXAoKCkgPT4gdGhpcy5sb2FkaW5nJC5uZXh0KGZhbHNlKSlcbiAgICAgICAgICApO1xuICAgICAgfTtcblxuICAgICAgaWYgKHBvcHVsYXRlLmRlcGVuZGVuY3kpIHtcblxuICAgICAgICBjb25zdCBwb2ludGVyID0gdGhpcy5jRGF0YS5wb2ludGVyc1twb3B1bGF0ZS5kZXBlbmRlbmN5LmtleV07XG4gICAgICAgIGNvbnN0IGdtID0gc2FmZUV2YWwocG9wdWxhdGUuZGVwZW5kZW5jeS5tZXRob2QpO1xuXG4gICAgICAgIHRoaXMuZGF0YVNldCQgPSBwb2ludGVyLmNvbnRyb2wudmFsdWVDaGFuZ2VzXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBzdGFydFdpdGgoXG4gICAgICAgICAgICAgIHBvaW50ZXIuY29udHJvbC52YWx1ZVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIHN3aXRjaE1hcCh2YWx1ZSA9PlxuICAgICAgICAgICAgICBkb2N1bWVudHNNZXRob2QoXG4gICAgICAgICAgICAgICAgZ20odmFsdWUsIHtcbiAgICAgICAgICAgICAgICAgIGZpZWxkRGF0YTogdGhpcy5jRGF0YSxcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiB0aGlzLmNEYXRhLmZvcm0uZ2V0UmF3VmFsdWUoKSxcbiAgICAgICAgICAgICAgICAgIHJvbGU6IHRoaXMucm9sZSxcbiAgICAgICAgICAgICAgICAgIGFkZGl0aW9uYWxDb250ZXh0OiB0aGlzLmFkZGl0aW9uYWxDb250ZXh0XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICB9IGVsc2Uge1xuXG4gICAgICAgIGxldCBmaWx0ZXI6IFdoZXJlRmlsdGVyID0gcG9wdWxhdGUuZmlsdGVyIGFzIFdoZXJlRmlsdGVyO1xuXG4gICAgICAgIGlmIChwb3B1bGF0ZS5keW5hbWljRmlsdGVyKSB7XG4gICAgICAgICAgZmlsdGVyID0gc2FmZUV2YWwocG9wdWxhdGUuZHluYW1pY0ZpbHRlcikoe1xuICAgICAgICAgICAgZmllbGREYXRhOiB0aGlzLmNEYXRhLFxuICAgICAgICAgICAgdmFsdWU6IHRoaXMuY0RhdGEuZm9ybS5nZXRSYXdWYWx1ZSgpLFxuICAgICAgICAgICAgcm9sZTogdGhpcy5yb2xlLFxuICAgICAgICAgICAgYWRkaXRpb25hbENvbnRleHQ6IHRoaXMuYWRkaXRpb25hbENvbnRleHRcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGF0YVNldCQgPSBkb2N1bWVudHNNZXRob2Qoe1xuICAgICAgICAgIGNvbGxlY3Rpb246IHBvcHVsYXRlLmNvbGxlY3Rpb24sXG4gICAgICAgICAgb3JkZXJCeTogcG9wdWxhdGUub3JkZXJCeSxcbiAgICAgICAgICBmaWx0ZXJcbiAgICAgICAgfSBhcyBhbnkpO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmRhdGFTZXQkID0gb2YodGhpcy5jRGF0YS5kYXRhU2V0IGFzIGFueSk7XG4gICAgfVxuICB9XG59XG4iXX0=