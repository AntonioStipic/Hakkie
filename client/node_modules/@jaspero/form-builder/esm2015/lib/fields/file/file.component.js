import { ChangeDetectionStrategy, ChangeDetectorRef, Component, Inject, ViewChild } from '@angular/core';
import { MatSnackBar } from '@angular/material/snack-bar';
import { TranslocoService } from '@ngneat/transloco';
import { from, of, throwError } from 'rxjs';
import { switchMap, tap } from 'rxjs/operators';
import { FieldComponent } from '../../field/field.component';
import { FormBuilderService } from '../../form-builder.service';
import { StorageService } from '../../services/storage.service';
import { COMPONENT_DATA } from '../../utils/create-component-injector';
import { formatFileName } from '../../utils/format-file-name';
import { parseSize } from '../../utils/parse-size';
export class FileComponent extends FieldComponent {
    constructor(cData, storage, cdr, formBuilderService, transloco, snackBar) {
        super(cData);
        this.cData = cData;
        this.storage = storage;
        this.cdr = cdr;
        this.formBuilderService = formBuilderService;
        this.transloco = transloco;
        this.snackBar = snackBar;
    }
    ngOnInit() {
        if (this.cData.control.value) {
            this.name = this.cData.control.value;
        }
        this.emptyLabel = (this.cData.hasOwnProperty('emptyLabel') ? this.cData.emptyLabel : 'FIELDS.FILE.EMPTY');
        this.formBuilderService.saveComponents.push(this);
        this.allowedFileTypes = this.cData.allowedFileTypes || [];
        this.forbiddenFileTypes = this.cData.forbiddenFileTypes || [];
        this.minSizeBytes = this.cData.minSize ? parseSize(this.cData.minSize) : 0;
        this.maxSizeBytes = this.cData.maxSize ? parseSize(this.cData.maxSize) : 0;
    }
    errorSnack(message = 'GENERAL.ERROR', dismiss = 'GENERAL.DISMISS') {
        this.snackBar.open(this.transloco.translate(message), this.transloco.translate(dismiss), {
            panelClass: 'snack-bar-error',
            duration: 5000
        });
    }
    fileChange(ev) {
        const el = ev.target;
        const file = Array.from(el.files)[0];
        Object.defineProperty(file, 'name', {
            writable: true,
            value: formatFileName(file.name)
        });
        if (!this.allowedFileTypes.includes(file.type) && !!this.allowedFileTypes.length) {
            this.errorSnack('FIELDS.FILE.INVALID_FILE_FORMAT');
            return throwError('Invalid File Format');
        }
        if (this.forbiddenFileTypes.includes(file.type)) {
            this.errorSnack('FIELDS.FILE.FORBIDDEN_FILE_FORMAT');
            return throwError('Forbidden File Format');
        }
        if (file.size < this.minSizeBytes) {
            this.errorSnack('FIELDS.FILE.BELOW_SIZE');
            return throwError('File below minimal allowed size');
        }
        if (file.size > this.maxSizeBytes && !!this.maxSizeBytes) {
            this.errorSnack('FIELDS.FILE.EXCEED_SIZE');
            return throwError('File exceeding allowed size');
        }
        this.value = file;
        if (this.value) {
            this.name = this.value.name;
        }
        el.value = '';
    }
    clear() {
        this.name = '';
        this.cData.control.setValue('');
    }
    save(moduleId, documentId) {
        if (this.value) {
            const name = [
                moduleId,
                documentId,
                this.value.name
            ]
                .join('-');
            return from(this.storage.upload(name, this.value, {
                contentType: this.value.type,
                customMetadata: {
                    moduleId,
                    documentId
                }
            })).pipe(switchMap((res) => res.ref.getDownloadURL()), tap(url => this.cData.control.setValue(url)));
        }
        else {
            return of({});
        }
    }
}
FileComponent.decorators = [
    { type: Component, args: [{
                selector: 'fb-file',
                template: "<div class=\"mat-form-field-wrapper\">\n  <fieldset class=\"fb-file\">\n    <input #file type=\"file\" hidden (change)=\"fileChange($event)\">\n\n    <legend class=\"fb-file-legend\">{{(cData.label || '') | transloco}}</legend>\n\n    <div class=\"fb-file-field\">\n      <span class=\"fb-file-field-name\">{{name || (emptyLabel | transloco)}}</span>\n\n      <div class=\"fb-file-field-actions\">\n        <ng-container *ngIf=\"!cData.preventClear && name\">\n          <button mat-button (click)=\"clear()\">{{'REMOVE' | transloco}}</button>|\n        </ng-container>\n        <button mat-button (click)=\"file.click()\">{{'ADD' | transloco}}</button>\n      </div>\n    </div>\n  </fieldset>\n</div>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: [".fb-file{border:1px solid var(--panel-tertiary);border-radius:4px;overflow:hidden;transition:.2s}.fb-file:hover{border:1px solid var(--panel-primary);box-shadow:0 0 0 1px var(--panel-primary)}.fb-file:focus-within{border:1px solid var(--primary-theme);box-shadow:0 0 0 1px var(--primary-theme)}.fb-file-legend{background:var(--panel-theme);color:var(--panel-secondary);font-size:.8em;margin-left:-8px;padding:0 4px}.fb-file-field{align-items:center;display:flex}.fb-file-field-name{color:var(--panel-secondary);flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:1px}.fb-file-field-actions{margin-left:auto;white-space:nowrap}"]
            },] }
];
FileComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [COMPONENT_DATA,] }] },
    { type: StorageService },
    { type: ChangeDetectorRef },
    { type: FormBuilderService },
    { type: TranslocoService },
    { type: MatSnackBar }
];
FileComponent.propDecorators = {
    fileEl: [{ type: ViewChild, args: ['file', { static: true },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9mb3JtLWJ1aWxkZXIvc3JjL2xpYi9maWVsZHMvZmlsZS9maWxlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsdUJBQXVCLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFjLE1BQU0sRUFBVSxTQUFTLEVBQUMsTUFBTSxlQUFlLENBQUM7QUFDM0gsT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLDZCQUE2QixDQUFDO0FBQ3hELE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxNQUFNLG1CQUFtQixDQUFDO0FBQ25ELE9BQU8sRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBQyxNQUFNLE1BQU0sQ0FBQztBQUMxQyxPQUFPLEVBQUMsU0FBUyxFQUFFLEdBQUcsRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzlDLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSw2QkFBNkIsQ0FBQztBQUMzRCxPQUFPLEVBQUMsa0JBQWtCLEVBQUMsTUFBTSw0QkFBNEIsQ0FBQztBQUU5RCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFDOUQsT0FBTyxFQUFDLGNBQWMsRUFBQyxNQUFNLHVDQUF1QyxDQUFDO0FBQ3JFLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSw4QkFBOEIsQ0FBQztBQUM1RCxPQUFPLEVBQUMsU0FBUyxFQUFDLE1BQU0sd0JBQXdCLENBQUM7QUFpQmpELE1BQU0sT0FBTyxhQUFjLFNBQVEsY0FBd0I7SUFZekQsWUFDaUMsS0FBZSxFQUN0QyxPQUF1QixFQUN2QixHQUFzQixFQUN0QixrQkFBc0MsRUFDdEMsU0FBMkIsRUFDM0IsUUFBcUI7UUFFN0IsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBUGtCLFVBQUssR0FBTCxLQUFLLENBQVU7UUFDdEMsWUFBTyxH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QUNILENBQUMsSUFBSSxDQUNKLFNBQVMsQ0FBQyxDQUFDLEdBQVEsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxFQUNqRCxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FDN0MsQ0FBQztTQUNIO2FBQU07WUFDTCxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUNmO0lBQ0gsQ0FBQzs7O1lBeEhGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsU0FBUztnQkFDbkIsNHNCQUFvQztnQkFFcEMsZUFBZSxFQUFFLHVCQUF1QixDQUFDLE1BQU07O2FBQ2hEOzs7NENBY0ksTUFBTSxTQUFDLGNBQWM7WUFqQ2xCLGNBQWM7WUFSVyxpQkFBaUI7WUFNMUMsa0JBQWtCO1lBSmxCLGdCQUFnQjtZQURoQixXQUFXOzs7cUJBNEJoQixTQUFTLFNBQUMsTUFBTSxFQUFFLEVBQUMsTUFBTSxFQUFFLElBQUksRUFBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Q2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEluamVjdCwgT25Jbml0LCBWaWV3Q2hpbGR9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtNYXRTbmFja0Jhcn0gZnJvbSAnQGFuZ3VsYXIvbWF0ZXJpYWwvc25hY2stYmFyJztcbmltcG9ydCB7VHJhbnNsb2NvU2VydmljZX0gZnJvbSAnQG5nbmVhdC90cmFuc2xvY28nO1xuaW1wb3J0IHtmcm9tLCBvZiwgdGhyb3dFcnJvcn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge3N3aXRjaE1hcCwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0ZpZWxkQ29tcG9uZW50fSBmcm9tICcuLi8uLi9maWVsZC9maWVsZC5jb21wb25lbnQnO1xuaW1wb3J0IHtGb3JtQnVpbGRlclNlcnZpY2V9IGZyb20gJy4uLy4uL2Zvcm0tYnVpbGRlci5zZXJ2aWNlJztcbmltcG9ydCB7RmllbGREYXRhfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL2ZpZWxkLWRhdGEuaW50ZXJmYWNlJztcbmltcG9ydCB7U3RvcmFnZVNlcnZpY2V9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3N0b3JhZ2Uuc2VydmljZSc7XG5pbXBvcnQge0NPTVBPTkVOVF9EQVRBfSBmcm9tICcuLi8uLi91dGlscy9jcmVhdGUtY29tcG9uZW50LWluamVjdG9yJztcbmltcG9ydCB7Zm9ybWF0RmlsZU5hbWV9IGZyb20gJy4uLy4uL3V0aWxzL2Zvcm1hdC1maWxlLW5hbWUnO1xuaW1wb3J0IHtwYXJzZVNpemV9IGZyb20gJy4uLy4uL3V0aWxzL3BhcnNlLXNpemUnO1xuXG5pbnRlcmZhY2UgRmlsZURhdGEgZXh0ZW5kcyBGaWVsZERhdGEge1xuICBlbXB0eUxhYmVsPzogc3RyaW5nO1xuICBwcmV2ZW50Q2xlYXI/OiBib29sZWFuO1xuICBhbGxvd2VkRmlsZVR5cGVzPzogc3RyaW5nW107XG4gIGZvcmJpZGRlbkZpbGVUeXBlcz86IHN0cmluZ1tdO1xuICBtaW5TaXplPzogc3RyaW5nIHwgbnVtYmVyO1xuICBtYXhTaXplPzogc3RyaW5nIHwgbnVtYmVyO1xufVxuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdmYi1maWxlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2ZpbGUuY29tcG9uZW50Lmh0bWwnLFxuICBzdHlsZVVybHM6IFsnLi9maWxlLmNvbXBvbmVudC5zY3NzJ10sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoXG59KVxuZXhwb3J0IGNsYXNzIEZpbGVDb21wb25lbnQgZXh0ZW5kcyBGaWVsZENvbXBvbmVudDxGaWxlRGF0YT4gaW1wbGVtZW50cyBPbkluaXQge1xuICBAVmlld0NoaWxkKCdmaWxlJywge3N0YXRpYzogdHJ1ZX0pXG4gIGZpbGVFbDogRWxlbWVudFJlZjxIVE1MSW5wdXRFbGVtZW50PjtcbiAgdmFsdWU6IEZpbGU7XG4gIG5hbWU6IHN0cmluZztcbiAgZW1wdHlMYWJlbDogc3RyaW5nO1xuXG4gIGFsbG93ZWRGaWxlVHlwZXM6IHN0cmluZ1tdO1xuICBmb3JiaWRkZW5GaWxlVHlwZXM6IHN0cmluZ1tdO1xuICBtaW5TaXplQnl0ZXM6IG51bWJlcjtcbiAgbWF4U2l6ZUJ5dGVzOiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgQEluamVjdChDT01QT05FTlRfREFUQSkgcHVibGljIGNEYXRhOiBGaWxlRGF0YSxcbiAgICBwcml2YXRlIHN0b3JhZ2U6IFN0b3JhZ2VTZXJ2aWNlLFxuICAgIHByaXZhdGUgY2RyOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcml2YXRlIGZvcm1CdWlsZGVyU2VydmljZTogRm9ybUJ1aWxkZXJTZXJ2aWNlLFxuICAgIHByaXZhdGUgdHJhbnNsb2NvOiBUcmFuc2xvY29TZXJ2aWNlLFxuICAgIHByaXZhdGUgc25hY2tCYXI6IE1hdFNuYWNrQmFyXG4gICkge1xuICAgIHN1cGVyKGNEYXRhKTtcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGlmICh0aGlzLmNEYXRhLmNvbnRyb2wudmFsdWUpIHtcbiAgICAgIHRoaXMubmFtZSA9IHRoaXMuY0RhdGEuY29udHJvbC52YWx1ZTtcbiAgICB9XG5cbiAgICB0aGlzLmVtcHR5TGFiZWwgPSAodGhpcy5jRGF0YS5oYXNPd25Qcm9wZXJ0eSgnZW1wdHlMYWJlbCcpID8gdGhpcy5jRGF0YS5lbXB0eUxhYmVsIDogJ0ZJRUxEUy5GSUxFLkVNUFRZJykgYXMgc3RyaW5nO1xuXG4gICAgdGhpcy5mb3JtQnVpbGRlclNlcnZpY2Uuc2F2ZUNvbXBvbmVudHMucHVzaCh0aGlzKTtcblxuICAgIHRoaXMuYWxsb3dlZEZpbGVUeXBlcyA9IHRoaXMuY0RhdGEuYWxsb3dlZEZpbGVUeXBlcyB8fCBbXTtcbiAgICB0aGlzLmZvcmJpZGRlbkZpbGVUeXBlcyA9IHRoaXMuY0RhdGEuZm9yYmlkZGVuRmlsZVR5cGVzIHx8IFtdO1xuICAgIHRoaXMubWluU2l6ZUJ5dGVzID0gdGhpcy5jRGF0YS5taW5TaXplID8gcGFyc2VTaXplKHRoaXMuY0RhdGEubWluU2l6ZSkgOiAwO1xuICAgIHRoaXMubWF4U2l6ZUJ5dGVzID0gdGhpcy5jRGF0YS5tYXhTaXplID8gcGFyc2VTaXplKHRoaXMuY0RhdGEubWF4U2l6ZSkgOiAwO1xuICB9XG5cbiAgZXJyb3JTbmFjayhtZXNzYWdlOiBzdHJpbmcgPSAnR0VORVJBTC5FUlJPUicsIGRpc21pc3M6IHN0cmluZyA9ICdHRU5FUkFMLkRJU01JU1MnKSB7XG4gICAgdGhpcy5zbmFja0Jhci5vcGVuKFxuICAgICAgdGhpcy50cmFuc2xvY28udHJhbnNsYXRlKG1lc3NhZ2UpLFxuICAgICAgdGhpcy50cmFuc2xvY28udHJhbnNsYXRlKGRpc21pc3MpLFxuICAgICAge1xuICAgICAgICBwYW5lbENsYXNzOiAnc25hY2stYmFyLWVycm9yJyxcbiAgICAgICAgZHVyYXRpb246IDUwMDBcbiAgICAgIH1cbiAgICApO1xuICB9XG5cbiAgZmlsZUNoYW5nZShldjogRXZlbnQpIHtcbiAgICBjb25zdCBlbCA9IGV2LnRhcmdldCBhcyBIVE1MSW5wdXRFbGVtZW50O1xuICAgIGNvbnN0IGZpbGUgPSBBcnJheS5mcm9tKGVsLmZpbGVzIGFzIEZpbGVMaXN0KVswXSBhcyBGaWxlO1xuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGZpbGUsICduYW1lJywge1xuICAgICAgd3JpdGFibGU6IHRydWUsXG4gICAgICB2YWx1ZTogZm9ybWF0RmlsZU5hbWUoZmlsZS5uYW1lKVxuICAgIH0pO1xuXG4gICAgaWYgKCF0aGlzLmFsbG93ZWRGaWxlVHlwZXMuaW5jbHVkZXMoZmlsZS50eXBlKSAmJiAhIXRoaXMuYWxsb3dlZEZpbGVUeXBlcy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZXJyb3JTbmFjaygnRklFTERTLkZJTEUuSU5WQUxJRF9GSUxFX0ZPUk1BVCcpO1xuICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ0ludmFsaWQgRmlsZSBGb3JtYXQnKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5mb3JiaWRkZW5GaWxlVHlwZXMuaW5jbHVkZXMoZmlsZS50eXBlKSkge1xuICAgICAgdGhpcy5lcnJvclNuYWNrKCdGSUVMRFMuRklMRS5GT1JCSURERU5fRklMRV9GT1JNQVQnKTtcbiAgICAgIHJldHVybiB0aHJvd0Vycm9yKCdGb3JiaWRkZW4gRmlsZSBGb3JtYXQnKTtcbiAgICB9XG5cbiAgICBpZiAoZmlsZS5zaXplIDwgdGhpcy5taW5TaXplQnl0ZXMpIHtcbiAgICAgIHRoaXMuZXJyb3JTbmFjaygnRklFTERTLkZJTEUuQkVMT1dfU0laRScpO1xuICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ0ZpbGUgYmVsb3cgbWluaW1hbCBhbGxvd2VkIHNpemUnKTtcbiAgICB9XG5cbiAgICBpZiAoZmlsZS5zaXplID4gdGhpcy5tYXhTaXplQnl0ZXMgJiYgISF0aGlzLm1heFNpemVCeXRlcykge1xuICAgICAgdGhpcy5lcnJvclNuYWNrKCdGSUVMRFMuRklMRS5FWENFRURfU0laRScpO1xuICAgICAgcmV0dXJuIHRocm93RXJyb3IoJ0ZpbGUgZXhjZWVkaW5nIGFsbG93ZWQgc2l6ZScpO1xuICAgIH1cblxuICAgIHRoaXMudmFsdWUgPSBmaWxlO1xuICAgIGlmICh0aGlzLnZhbHVlKSB7XG4gICAgICB0aGlzLm5hbWUgPSB0aGlzLnZhbHVlLm5hbWU7XG4gICAgfVxuICAgIGVsLnZhbHVlID0gJyc7XG4gIH1cblxuICBjbGVhcigpIHtcbiAgICB0aGlzLm5hbWUgPSAnJztcbiAgICB0aGlzLmNEYXRhLmNvbnRyb2wuc2V0VmFsdWUoJycpO1xuICB9XG5cbiAgc2F2ZShtb2R1bGVJZDogc3RyaW5nLCBkb2N1bWVudElkOiBzdHJpbmcpIHtcbiAgICBpZiAodGhpcy52YWx1ZSkge1xuICAgICAgY29uc3QgbmFtZSA9IFtcbiAgICAgICAgbW9kdWxlSWQsXG4gICAgICAgIGRvY3VtZW50SWQsXG4gICAgICAgIHRoaXMudmFsdWUubmFtZVxuICAgICAgXVxuICAgICAgICAuam9pbignLScpO1xuXG4gICAgICByZXR1cm4gZnJvbShcbiAgICAgICAgdGhpcy5zdG9yYWdlLnVwbG9hZChuYW1lLCB0aGlzLnZhbHVlLCB7XG4gICAgICAgICAgY29udGVudFR5cGU6IHRoaXMudmFsdWUudHlwZSxcbiAgICAgICAgICBjdXN0b21NZXRhZGF0YToge1xuICAgICAgICAgICAgbW9kdWxlSWQsXG4gICAgICAgICAgICBkb2N1bWVudElkXG4gICAgICAgICAgfVxuICAgICAgICB9KVxuICAgICAgKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKHJlczogYW55KSA9PiByZXMucmVmLmdldERvd25sb2FkVVJMKCkpLFxuICAgICAgICB0YXAodXJsID0+IHRoaXMuY0RhdGEuY29udHJvbC5zZXRWYWx1ZSh1cmwpKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG9mKHt9KTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==